<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<link rel="stylesheet" href="../resource/css/common.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script type="text/javascript" src="../resource/js/common.util.js"></script>


<script>
var paramToObject = function(){
	
	var r =  window.location.search.replace("?","");
	var a = r.split("&");
	var o = {};
	var i = 0,iLen = a.length,io;
	
	for(;i<iLen;++i){
		io = a[ i ];
		var _ta = io.split( "=" );
		o[ _ta[0] ] = _ta[ 1 ];
	}
	console.log( o )
	return o;
};

var getTrdData = function( date, sort, type, cbFunction ){

	date = date || window.url.params.date

	var xhr = new XMLHttpRequest();
    xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getTrdData?date=${date}&sort=${sort}&type=${type}` ) , true);
    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            var a =JSON.parse(xhr.responseText);
	
			cbFunction( a, sort );
		
		}
		
	}
	xhr.send();
}

var htmlToElement = function( html ){
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

var renderTrs = function(){
	
	var _tdom = window.document.getElementById("searchTrs");
	var arr = window.CONST.traders;
	var i = 0,iLen = arr.length,io;
	for(;i<iLen;++i){
		io = arr[ i ];
		var new_el = htmlToElement( `<td style="text-align:center;cursor:pointer;" data-cd-value="${window.CONST.tradersCd[i]}" class="sort">${io}</td>` )
	
		//_tdom.insertBefore( new_el,_tdom.firstChild )
		_tdom.appendChild( new_el )
		new_el.addEventListener( "click",function(e){
				var cd = e.currentTarget.getAttribute("data-cd-value");
				var sort_arr = window.document.getElementsByClassName("sort");
				var i = 0,iLen = sort_arr.length,io;
				for(;i<iLen;++i){
					io = sort_arr[ i ];
					io.style = {};
					io.style.textAlign = "center"
					io.style.cursor = "pointer"

				}
				e.currentTarget.style.backgroundColor = "red";
				e.currentTarget.style.color = "#fff";

				getTrdData( window.url.params.date,cd,"b", function(d){	renderAgcDailyTreemap_buy( d, cd ); });
				getTrdData( window.url.params.date,cd,"s", function(d){	renderAgcDailyTreemap_sell( d, cd ); });
		
		})
	}

	
}


var renderAgcDailyTreemap_buy = function( d, sort ){
		
		window.chartData.b = [];
		if( d.length == 0 ) return;
			var i = 0,iLen = d.length,io;
			for(;i<iLen;++i){
				io = d[ i ];
				
				var symbol = "▲"
				if( io.rt == 0 ) var symbol = "-";
				if( io.rt < 0 ) var symbol = "▼";
				
				var _chart_o = {
					name: io.nm,
					price : io.price,
					rt : io.rt,
					rtMarker : symbol,
					ydt : io.ydt,
					b: io.b[ sort ],
					s: io.s[ sort ],
					pp: io.pp[ sort ],
					value: io.b[ sort ],
					children: []
				}
				window.chartData.b.push( _chart_o )	
			}


		var dom = document.getElementById("renderAgcDailyTreemap_buy");
		window.charts.renderAgcDailyTreemap_buy = echarts.init(dom);

		window.charts.renderAgcDailyTreemap_buy.showLoading();

		var app = {};

		var option = {
			grid : { width :"100%" },
			series: [
				{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false, breadcrumb : { show : false,	}, width :"100%", height :"100%",
					data: window.chartData.b,
					label : { 
						formatter: function (params){
							let arr = [
								"{title|" + params.name + "}",
								"{a|" + echarts.format.addCommas(params.data.price) + " " + params.data.rtMarker + params.data.ydt + " " +  "( " +echarts.format.addCommas(params.data.rt) + "% )}",			
								"{hr|}",
								"{a| 매수 : "  + window.UTIL.Number.longNumberAddString(params.data.b ) + "}",
								"{a| 메도 : " + window.UTIL.Number.longNumberAddString(params.data.s ) + "}",
								"{hr|}",
								"{b| 순매수 : " + window.UTIL.Number.longNumberAddString(params.data.pp ) + "}",
							];
							return arr.join('\n');
						},
						rich : {
							title : { fontSize: 14 },
							a : { fontSize: 9 },
							b : { fontSize: 12 },
							hr : { 
								width : "100%",
								borderColor : "rgba(255,255,255,0.0)",
								borderWidth : 0.5,
								height : 0,
								lineHeight : 10,
							}
						}
					},
					levels: [{ color: ['pink','red'],colorMappingBy: 'value',itemStyle: { gapWidth: 1 } }]
				}
			]
		};

		if (option && typeof option === 'object'){
			window.charts.renderAgcDailyTreemap_buy.setOption(option);
			window.charts.renderAgcDailyTreemap_buy.resize();
			
			setTimeout(function(){
				window.charts.renderAgcDailyTreemap_buy.hideLoading();
			},1000)

		}

}


var renderAgcDailyTreemap_sell = function( d, sort ){
		
		window.chartData.s = [];
		if( d.length == 0 ) return;
		var i = 0,iLen = d.length,io;
		for(;i<iLen;++i){
			io = d[ i ];
			
			var symbol = "▲"
			if( io.rt == 0 ) var symbol = "-";
			if( io.rt < 0 ) var symbol = "▼";
			
			var _chart_o = {
				name: io.nm,
				price : io.price,
				rt : io.rt,
				rtMarker : symbol,
				ydt : io.ydt,
				b: io.b[ sort ],
				s: io.s[ sort ],
				pp: io.pp[ sort ],
				value: io.s[ sort ],
				children: []
			}
			window.chartData.s.push( _chart_o )	
		}


		var dom = document.getElementById("renderAgcDailyTreemap_sell");
		window.charts.renderAgcDailyTreemap_sell = echarts.init(dom);

		window.charts.renderAgcDailyTreemap_sell.showLoading();

		var app = {};

		var option = {
			grid : { width :"100%" },
			series: [
				{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false, breadcrumb : { show : false,	}, width :"100%", height :"100%",
					data: window.chartData.s,
					label : { 
						formatter: function (params){
							let arr = [
								"{title|" + params.name + "}",
								"{a|" + echarts.format.addCommas(params.data.price) + " " + params.data.rtMarker + params.data.ydt + " " +  "( " +echarts.format.addCommas(params.data.rt) + "% )}",			
								"{hr|}",
								"{a| 매수 : "  + window.UTIL.Number.longNumberAddString(params.data.b ) + "}",
								"{a| 메도 : " + window.UTIL.Number.longNumberAddString(params.data.s ) + "}",
								"{hr|}",
								"{b| 순매수 : " + window.UTIL.Number.longNumberAddString(params.data.pp ) + "}",
							];
							return arr.join('\n');
						},
						rich : {
							title : { fontSize: 14 },
							a : { fontSize: 9 },
							b : { fontSize: 12 },
							hr : { 
								width : "100%",
								borderColor : "rgba(255,255,255,0.0)",
								borderWidth : 0.5,
								height : 0,
								lineHeight : 10,
							}
						}
					},
					levels: [{ color: ['skyblue','blue'],colorMappingBy: 'value',itemStyle: { gapWidth: 1 } }]
				}
			]
		};

		if (option && typeof option === 'object'){
			window.charts.renderAgcDailyTreemap_sell.setOption(option);
			window.charts.renderAgcDailyTreemap_sell.resize();
			
			setTimeout(function(){
				window.charts.renderAgcDailyTreemap_sell.hideLoading();
			},1000)

		}

}


window.onload = function(){ 


	window.Websocket.init();

	window.COMPONENT.gnb();
	window.COMPONENT.stockSearch_global();
	
	window.CONST = {};
	window.CONST.traders = [ "개인",	"외국인", "기관계","금융투자","보험","투신","기타금융","은행","연기금등","사모펀드","국가","기타법인","내외국인" ];
	window.CONST.tradersCd = [ "tr1","tr2","tr3","tr4","tr5","tr6","tr7","tr8","tr9","tr10","tr11","tr12","tr13" ];

	window.url = {};
	window.url.params = window.UTIL.Url.paramToObject();
	
	window.charts = {};
	window.charts.renderTreemapChart = {};
	window.chartData = {
		b : [],
		s : [],
	};
	
	renderTrs();

	getTrdData( window.url.params.date,"tr9","b", function(d){	renderAgcDailyTreemap_buy( d, "tr9" ); });
	getTrdData( window.url.params.date,"tr9","s", function(d){	renderAgcDailyTreemap_sell( d, "tr9" ); });

	window.addEventListener('resize', function(e){ 
		var s,so;
		for( s in window.charts ){
			so = window.charts[ s ];
			so.resize();
		}
	}, true);
}
</script>

<body style="padding:20px">
	
	<div class="ui stackable grid">
		<div id="gnb" class="eight wide column" style="padding: 20px;"></div>
		<div id="search_wrap" class="eight wide column" style="padding: 20px;"></div>

		<div class="sixteen wide cloumn">
			<h3>기관 매매 동향</h3><span>(단위 : 백만 ) - 20시이후 업데이트</span>
		</div>

		<div class="sixteen wide column" style="">
			<table class="ui celled table compact">
				<tbody>
					<tr id="searchTrs"></tr>
				</tbody>
			</table>
		</div>

		<div id="renderAgcDailyTreemap_buy" class="sixteen wide column" style="height:400px"></div>
		<div id="renderAgcDailyTreemap_sell" class="sixteen wide column" style="height:400px"></div>
		
		<div class="sixteen wide column">
			<div class="ui one cards" id="cards"></div>
		</div>

	</div>

</body>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<link rel="stylesheet" href="../resource/css/common.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script type="text/javascript" src="../resource/js/common.util.js"></script>


<script>

var updateStock = function(){
		
		

		var cd = window.stock_arr[ updateStock.cnt ];
		var xhr = new XMLHttpRequest();

		xhr.open("GET" , "http://112.144.208.118:8888/getStockInfoByCd?cd=" + cd, true);

		xhr.onreadystatechange = function() {

			if(xhr.readyState == 4 && xhr.status == 200)

			{
	//			console.log( xhr.responseText )
				var d = JSON.parse( xhr.responseText )
				debugger;
				var _htmlTxt = `
				<span style='font-size:25px;'>${ d.name }</span>  ( ${ d.symbolCode } )<br>
				<span style="color:black;font-size:14px;">  ${window.UTIL.Number.numberWithCommas( d.askPrice )}</span>
				<span style="color:black;">  ${d.changePrice} ( ${(d.changeRate*100).toFixed(2)} % )</span></br>
				<span style="">  거래량 : ${window.UTIL.Number.numberWithCommas( d.accTradeVolume )}   <br>   거래대금 ${window.UTIL.Number.numberWithCommas( d.accTradePrice )} </span>
				`
				window.document.getElementById( cd ).innerHTML = _htmlTxt
				window.document.getElementById( "summaray_"+cd ).innerHTML = `<span style="font-size:11px;">${d.companySummary}</span>`
				if( updateStock.cnt == window.stock_arr.length - 1 )
				{
					console.log("업데이트끝")
					updateStock.cnt = 0;
					updateStock.status = 0;
				}
				else
				{
					++updateStock.cnt;
					updateStock.status = 1
					setTimeout(function(){ updateStock()  },300)
				}
			}

		}

		xhr.send();
	
	
}
updateStock.cnt = 0;
updateStock.status = 0;

var getStockInfoByCd = function(cd,cbFunction){
	var xhr = new XMLHttpRequest();

	//http://112.144.208.118:8888/getCandleDataByCd?cd=510007&startTime=20220201&endTime=20220214
	xhr.open("GET" , `http://112.144.208.118:8888/getStockInfoByCd?cd=${cd}`, true);

	xhr.onreadystatechange = function() {

		if(xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText );
			
			cbFunction(d)
		}

	}
	xhr.send();
}


var paramToObject = function(){
	
	var r =  window.location.search.replace("?","");
	var a = r.split("&");
	var o = {};
	var i = 0,iLen = a.length,io;
	
	for(;i<iLen;++i){
		io = a[ i ];
		var _ta = io.split( "=" );
		o[ _ta[0] ] = _ta[ 1 ];
	}
	console.log( o )
	return o;
};

var getTrdData = function( date, sort, cbFunction ){

	date = date || window.url.params.date

	var xhr = new XMLHttpRequest();
    xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getTrdData?date=${date}&sort=${sort}` ) , true);
    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            var a =JSON.parse(xhr.responseText);
			cbFunction( a, sort );
		
		}
		
	}
	xhr.send();
}

var renderStock = function( arr, sort ){
	
	if( arr.length == 0 ) return;
	window.chartData = [];
	var _html = "";
	var i = 0,iLen = arr.length,io;
	for(;i<iLen;++i){
	io = arr[ i ];
	
		if( io.ydt == 0 ) var status = {	color:"grey	", symbol : "-",}
		if( io.ydt > 0 ) var status = {	color:"red", symbol : "▲",}
		if( io.ydt < 0 ) var status = {	color:"blue", symbol : "▼",}

		var _html00 = `
		<div class="card"  style="padding: 10px;box-shadow: 0 0px 3px 0 #fff, 0 0 0 3px #fff !important;border-radius: 0rem !important;">
		<div style="padding-top:20px;background-color:#fff;">
		<span style='color:black;font-size:24px;'>${io.nm}</span> (${io.cd})
		</div>
		<div style="padding-bottom:20px;">
		<span style="color:${status.color};font-size:15px;">${io.price}</span>
		<span style="color:${status.color}">${status.symbol}${io.ydt} ( ${io.rt}% )</span>
		</div>
		<div class='image' style="padding-bottom:10px;background-color:#fff;">
		<img class='chart' src='https://ssl.pstatic.net/imgfinance/chart/item/candle/day/${io.cd}.png' height='100' loading='lazy'></div>
		<div>
		<table class="ui celled table compact">
			<thead>
				<tr>
					<th> 구분</th>
					<th> 매수(단위:백만) </th>
					<th> 매도(단위:백만)  </th>
					<th> 순매수(단위:백만)   </th>
				</tr>
			</thead>
			<tbody>
		`

				
		var s,so00,so01,so01,cnt = 0;
		for( s in io.b ){
			
			so00 = io.b[ s ];
			so01 = io.s[ s ];
			so02 = io.pp[ s ];

			var checkColor =  so00 + so01
			if( checkColor > 0) var bColor="#f7dddd",color = "#ff0000"
			else if( checkColor < 0) var bColor = "#dcecff",color="#0072ff"
			else var bColor = "#fffeea",color="#000"
			
			_html00 += `
			<tr style="color:${color};background-color:${bColor}">
				<td> ${window.CONST.traders[ cnt ]} 	</td><td>	${so00}		</td><td>  ${so01}  </td><td>  ${so02}  </td>
			</tr>`
			++cnt;
				
		}

		_html00 += `
					</tbody>
				</table>
			</div>
		</div>
		`
		_html += _html00
			
		var symbol = "▲"
		if( io.rt == 0 ) 
		{
			var symbol = "-"
		}
		if( io.rt < 0 ) 
		{
			var symbol = "▼"	
		}
		

		var _chart_o = {
			name: io.nm,
			price : io.price,
			rt : io.rt,
			rtMarker : symbol,
			ydt : io.ydt,
			b: io.b[ sort ],
			s: io.s[ sort ],
			pp: io.pp[ sort ],
			value: io.pp[ sort ],
			children: []
		}
		window.chartData.push( _chart_o )
			
			
	}
	var _tdom = window.document.getElementById("cards");
	_tdom.innerHTML = _html;
}

var htmlToElement = function( html ){
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

var renderTrs = function(){
	
	var _tdom = window.document.getElementById("searchTrs");
	var arr = window.CONST.traders;
	var i = 0,iLen = arr.length,io;
	for(;i<iLen;++i){
		io = arr[ i ];
		var new_el = htmlToElement( `<td style="text-align:center;cursor:pointer;" data-cd-value="${window.CONST.tradersCd[i]}" class="sort">${io}</td>` )
	
		//_tdom.insertBefore( new_el,_tdom.firstChild )
		_tdom.appendChild( new_el )
		new_el.addEventListener( "click",function(e){
				var cd = e.currentTarget.getAttribute("data-cd-value");
				var sort_arr = window.document.getElementsByClassName("sort");
				var i = 0,iLen = sort_arr.length,io;
				for(;i<iLen;++i){
					io = sort_arr[ i ];
					io.style = {};
					io.style.textAlign = "center"
					io.style.cursor = "pointer"

				}
				e.currentTarget.style.backgroundColor = "red";
				e.currentTarget.style.color = "#fff";

				getTrdData( window.url.params.date,cd, function(d){
					renderStock(d,cd);
					renderTreemapChart();
				})
		
		})
	}

	
}


var renderTreemapChart = function(){
		var dom = document.getElementById("container");
		window.charts.treemapChart = echarts.init(dom);

		window.charts.treemapChart.showLoading();

		var app = {};

		var option = {
			grid : { width :"100%" },
			series: [
				{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false, breadcrumb : { show : false,	}, width :"100%", height :"100%",
					data: window.chartData,
					label : { 
						formatter: function (params){
							let arr = [
								"{title|" + params.name + "}",
								"{a|" + echarts.format.addCommas(params.data.price) + " " + params.data.rtMarker + params.data.ydt + " " +  "(" +echarts.format.addCommas(params.data.rt) + ")%}",			
								"{hr|}",
								"{a| 매수 : "  + window.UTIL.Number.longNumberAddString(params.data.b ) + "}",
								"{a| 메도 : " + window.UTIL.Number.longNumberAddString(params.data.s ) + "}",
								"{hr|}",
								"{b| 순매수 : " + window.UTIL.Number.longNumberAddString(params.data.pp ) + "}",
							];
							return arr.join('\n');
						},
						rich : {
							title : { fontSize: 14 },
							a : { fontSize: 9 },
							b : { fontSize: 12 },
							hr : { 
								width : "100%",
								borderColor : "rgba(255,255,255,0.0)",
								borderWidth : 0.5,
								height : 0,
								lineHeight : 10,
							}
						}
					},
					levels: [{ color: ['pink','red'],colorMappingBy: 'value',itemStyle: { gapWidth: 1 } }]
				}
			]
		};

		if (option && typeof option === 'object'){
			window.charts.treemapChart.setOption(option);
			window.charts.treemapChart.resize();
			
			setTimeout(function(){
				window.charts.treemapChart.hideLoading();
			},1000)

		}

}

window.onload = function(){ 


	window.Websocket.init();

	window.COMPONENT.gnb();
	window.COMPONENT.stockSearch_global();


	var div00 = window.document.getElementById("div00");
	var cards = window.document.getElementById("cards");
	
	
	window.CONST = {};
	window.CONST.traders = [ "개인",	"외국인", "기관계","금융투자","보험","투신","기타금융","은행","연기금등","사모펀드","국가","기타법인","내외국인" ];
	window.CONST.tradersCd = [ "tr1","tr2","tr3","tr4","tr5","tr6","tr7","tr8","tr9","tr10","tr11","tr12","tr13" ];

	window.stock = {};
	window.stock_arr = [];
	window.url = {};
	window.url.params = paramToObject();
	
	window.charts = {};
	window.charts.treemapChart = {};

	window.chartData = [];
	
	renderTrs();
	getTrdData( window.url.params.date,"tr9", function(d){

		renderStock(d,"tr9");
		renderTreemapChart();
	})
	window.addEventListener("resize",function(e){
		window.charts.treemapChart.resize();
	})
}
</script>

<body style="padding:50px">
	
	<div class="ui stackable grid">
		<div id="gnb" class="eight wide column" style="padding: 20px;"></div>
		<div id="search_wrap" class="eight wide column" style="padding: 20px;"></div>

		<div class="sixteen wide cloumn">
			<h3>기관 매매 동향</h3><span>(단위 : 백만 ) - 20시이후 업데이트</span>
		</div>

		<div class="sixteen wide column" style="">
			<table class="ui celled table compact">
				<tbody>
					<tr id="searchTrs"></tr>
				</tbody>
			</table>
		</div>

		<div class="sixteen wide column" style="height:400px">
			<div id="container" style="width:100%;height: 100%"></div>	
		</div>
		
		<div class="sixteen wide column">
			<div class="ui three cards" id="cards"></div>
		</div>

	</div>

</body>

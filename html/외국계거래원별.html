<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<link rel="stylesheet" href="../resource/css/common.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script type="text/javascript" src="../resource/js/common.util.js"></script>

<script>

var paramToObject = function(){
	
	var r =  window.location.search.replace("?","");
	var a = r.split("&");
	var o = {};
	var i = 0,iLen = a.length,io;
	
	for(;i<iLen;++i){
		io = a[ i ];
		var _ta = io.split( "=" );
		o[ _ta[0] ] = _ta[ 1 ];
	}
	console.log( o )
	return o;
};

var renderTreemapChart_buy = function( nm ){
	var domId = "renderTreemapChart_buy";	
	var dom = document.getElementById( domId );

	if( !window.charts.renderTreemapChart_buy )
	{
		window.charts.renderTreemapChart_buy = echarts.init(dom);
		window.charts.renderTreemapChart_buy.isEvent = 0;
	}

	window.charts.renderTreemapChart_buy.showLoading()


	var app = {};

	var option = {
		grid : { width :"100%" },
		series: [
			{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false, breadcrumb : { show : false,	}, width :"100%", height :"100%",
				data: window.chartData.renderTreemapChart_buy[ nm ],label : {
					formatter: function (params) {
						let arr = [ params.name, echarts.format.addCommas(params.value) ];
						return arr.join('\n');
					}
				},
				levels: [
					{ color: ['pink','red'],colorMappingBy: 'value',itemStyle: { gapWidth: 1 } }
				]
			}
		]
	};

	if (option && typeof option === 'object'){
		window.charts.renderTreemapChart_buy.setOption(option);
		window.charts.renderTreemapChart_buy.resize();
		
		setTimeout(function(){
			window.charts.renderTreemapChart_buy.hideLoading();
		},1000)
	}
	
	if( !window.charts.renderTreemapChart_buy.isEvent )
	{
		window.charts.renderTreemapChart_buy.on('click',function(d){
			getFtrdDataByCd( d.data.cd, d.data.name, function(d,nm){
				renderScatterChart(d,nm)
			}) 
		})
		window.charts.renderTreemapChart_buy.isEvent = 1;
	}
	
}

var renderTreemapChart_sell = function( nm ){

	var domId = "renderTreemapChart_sell";	
	var dom = document.getElementById( domId );

	if( !window.charts ) window.charts = {}
	if( !window.charts.renderTreemapChart_sell )
	{
		window.charts.renderTreemapChart_sell = echarts.init(dom);
		window.charts.renderTreemapChart_sell.isEvent = 0;
	}

	window.charts.renderTreemapChart_sell.showLoading()

	var app = {};

	var option = {
		grid : { width :"100%" },
		series: [
			{ 
				type: 'treemap', leafDepth: null, roam: false, nodeClick: false, breadcrumb : { show : false,	}, width :"100%", height :"100%",
				data: window.chartData.renderTreemapChart_sell[ nm ],label : {
					formatter: function (params) {
						let arr = [ params.name, echarts.format.addCommas(params.value) ];
						return arr.join('\n');
					}
				},
				levels: [
					{ color: ['skyblue','blue'], colorMappingBy: 'value', itemStyle: { gapWidth: 1 }}
				]
			}
		]
	};

	if (option && typeof option === 'object'){
		window.charts.renderTreemapChart_sell.setOption(option);
		window.charts.renderTreemapChart_sell.resize();
		
		setTimeout(function(){
			window.charts.renderTreemapChart_sell.hideLoading();
		},1000)
	}
	
	if( !window.charts.renderTreemapChart_sell.isEvent )
	{
		window.charts.renderTreemapChart_sell.on('click',function(d){
			getFtrdDataByCd( d.data.cd, d.data.name, function(d,nm){
				renderScatterChart(d,nm)
			}) 
		})
		window.charts.renderTreemapChart_sell.isEvent = 1;
	}
}


var getFtrdDataByCd = function( cd,nm,cbFunction ){
		
	var xhr = new XMLHttpRequest();
	
	xhr.open("GET" , `http://112.144.208.118:8888/getFtrdDataByCd?cd=${cd}&date=${window.date.curDate}`, true);
	xhr.onreadystatechange = function(){
		
		if( xhr.readyState == 4 && xhr.status == 200)
		{
			
			var d = JSON.parse( xhr.responseText )
			cbFunction( d,nm );
			
		}
	}
	
	xhr.send();

}
window.charts = {}
var renderScatterChart = function( d,nm ){

		//if( window.charts.renderScatterChart.dispose ) window.charts.renderScatterChart.dispose()
		var domId = "renderScatterChart";
		var dom = document.getElementById( domId );
		
		window.charts.renderScatterChart = echarts.init(dom);
		var app = {};
		
		window.charts.renderScatterChart.showLoading()

		var chartData = [];
		var legendData = [];
		
		var _to = {}
		var i = 0,iLen = d.length,io
		for(;i<iLen;++i){
			io = d[ i ];
			if( !_to[ io.tr ] ) _to[ io.tr ] = []
			var amt = io.amt;
			if( io.tt == 0 ) var amt = io.amt;
			_to[ io.tr ].push( [  "2022-02-22T"+ io.ogText.split("\t")[0],amt ] )
		}
		var s,so
		for( s in _to )
		{
			so = _to[ s ]
			legendData.push( s );
			_o = {  
				name: s, type: 'scatter',  emphasis: { focus: 'series' },
				data: so,
				//markPoint: { data: [ { type: 'max', name: 'Max' }, { type: 'min', name: 'Min' } ] },
				//markLine: {lineStyle: { type: 'solid'	},data: [{ type: 'average', name: 'AVG' }, { xAxis: 160 }] }
			}
			chartData.push( _o )
		}
		
		var title = nm;
		var subTitle = '외국계증권사 매수/매도 분포' + new Date();
		option = {
			title : { text : title, subtext : subTitle, left : 'center',},
			grid: { left: '3%', right: '7%', bottom: '10%', containLabel: true },
			tooltip: {
			// trigger: 'axis',
			showDelay: 0,
			formatter: function (params) {
				if (params.value.length > 1) return ( params.seriesName + ' :<br/>' + params.value[0] + ' / ' + params.value[1] );
				else return ( params.seriesName + ' :<br/>' + params.name + ' : ' +  params.value );
			},
			axisPointer: { show: true, type: 'cross', lineStyle: { type: 'dashed', width: 1 } }
			},
			visualMap: {
				min: -100, max: 100,
				dimension: 1, orient: 'vertical',
				right: 10, top: 'center', text: ['HIGH', 'LOW'],
				calculable: true,
				inRange: {
					color: ['#f2c31a', '#24b7f2']
				}
			},
			toolbox: { feature: { dataZoom: {}, brush: { type: ['rect', 'polygon', 'clear'] }	} },
			brush: {}, legend: { data: legendData,left: 'center',bottom: 10 },
			xAxis: [
				{ type: 'time',min:"2022-02-22T09:00:00",max:"2022-02-22T15:30:00", scale: true, boundaryGap: true,	axisLine: { onZero: true }, axisTick: { show: true }, splitLine: { show: true }, axisLabel: { show: true }, axisLabel : { fontSize : 9 }	}
			],
			yAxis: [
				{ type: 'value', scale: true, splitArea: {show: false },splitLine: { show: false },axisLine: { show: true }, axisLabel : { fontSize : 9 } },
			],
			series: chartData
		};

		if (option && typeof option === 'object') {
			window.charts.renderScatterChart.setOption(option);

			window.charts.renderScatterChart.resize();
			window.charts.renderScatterChart.hideLoading()
		}
			
}

var getInsightByTrad = function( cbFunction ){
		
	var xhr = new XMLHttpRequest();
	
	xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getInsightByTrad?date=${window.date.curDate}`), true);
	xhr.onreadystatechange = function(){
		
		if( xhr.readyState == 4 && xhr.status == 200)
		{
			
			var d = JSON.parse( xhr.responseText )

			var i = 0,iLen = d.length,io;
			for(;i<iLen;++i){
				io = d[ i ];
				
				if( !window.chartData.renderTreemapChart_buy[ io.nm ] ) window.chartData.renderTreemapChart_buy[ io.nm ] = [];
				if( !window.chartData.renderTreemapChart_sell[ io.nm ] ) window.chartData.renderTreemapChart_sell[ io.nm ] = [];
				
				var k,ko;
				for( k in io.stocks )
				{
					ko = io.stocks[ k ];
					var _chart_o = {
						name: ko.nm,
						cd : ko.cd,
						value: ko.b,
						children: []
					}
					var _chart_o00 = {
						name: ko.nm,
						cd : ko.cd,
						value: ko.s * -1,
						children: []
					}
					window.chartData.renderTreemapChart_buy[ io.nm ].push( _chart_o )
					window.chartData.renderTreemapChart_sell[ io.nm ].push( _chart_o00 )
				}
			}
			cbFunction( d );
			
		}
	}
	
	xhr.send();

}

var renderInsightByTrad = function(d){
	var _html =`
		<table class="ui sortable celled table compact">
			<thead>
				<th>증권사</th>
				<th>매수</th>
				<th>매도</th>
				<th>순매수</th>
			</thead>
			<tbody>
	`
	var i = 0,iLen = d.length,io;
	for(;i<iLen;++i){
		io = d[ i ];
		_html += `
		<tr class="traders" data-nm-value="${io.nm}">
			<td>${io.nm}</td>
			<td> ${window.UTIL.Number.numberWithCommas( io.total[ "s" ] )	}</td>
			<td> ${window.UTIL.Number.numberWithCommas( io.total[ "b" ] )	}</td>
			<td> ${window.UTIL.Number.numberWithCommas( io.total[ "s" ] + io.total[ "b" ] ) }</td>
		</tr>
		`
	}

	_html +=`
		</tbody>
	</table>
	`
	window.document.getElementById( "renderInsightByTrad" ).innerHTML = _html

	var trs = window.document.getElementsByClassName("traders");
	var i = 0,iLen = trs.length,io
	for(;i<iLen;++i){
		io = trs[ i ];
		io.addEventListener("click",function(e){
			var nm = e.currentTarget.getAttribute("data-nm-value");
			var sort_arr = window.document.getElementsByClassName("traders");
			var i = 0,iLen = sort_arr.length,io;
			for(;i<iLen;++i){
				io = sort_arr[ i ];
				io.style = {};
				io.style.textAlign = "center"
				io.style.cursor = "pointer"

			}
			e.currentTarget.style.backgroundColor = "red";
			e.currentTarget.style.color = "#fff";

			renderTreemapChart_buy( nm );
			renderTreemapChart_sell( nm );
	
		})
	}
	window.addEventListener("resize",function(e){
		window.charts.renderTreemapChart_buy.resize();
		window.charts.renderTreemapChart_sell.resize();
	})
}


window.onload = function(){ 

	window.chartData = {}
	window.chartData.renderTreemapChart_buy = {};
	window.chartData.renderTreemapChart_sell = {};
	
	window.charts = {};


	window.date = {};
	window.date.curDate = paramToObject().date;
	getInsightByTrad( renderInsightByTrad );

	window.Websocket.init();

	window.COMPONENT.gnb();
	window.COMPONENT.stockSearch_global();


}
</script>
       
<body style="padding:50px">

<div class="ui grid">

	<div id="gnb" class="eight wide column" style="padding: 20px;"></div>
	<div id="search_wrap" class="eight wide column" style="padding: 20px;"></div>

	<div class="four wide column">
		<div class="ui grid">
			<div class="sixteen wide column">외국계증권사 매매 동향</div>
			<div id="renderInsightByTrad" class="sixteen wide column" style=""></div>
		</div>
	</div>
	<div class="tewlve wide column">
		<div class="ui grid">
			<div class="sixteen wide column">외국계증권사 매매 동향</div>
			<div id="renderScatterChart" class="sixteen wide column" style="height:400px"></div>
			<div id="renderTreemapChart_buy" class="sixteen wide column" style="height:400px;"></div>
			<div id="renderTreemapChart_sell" class="sixteen wide column" style="height:400px;"></div>
		</div>
	</div>
</div>
</body>

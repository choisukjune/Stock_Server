<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<link rel="stylesheet" href="../resource/css/common.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<script type="text/javascript" src="../resource/js/common.util.js"></script>

<script>

var getTradersData = function( cbFunction ){

	var xhr = new XMLHttpRequest();
    xhr.open("GET" , encodeURI("http://112.144.208.118:8888/getInsightByStock?date=" + 	window.date.curDate ) , true);

    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            var a =JSON.parse(xhr.responseText);
			var chartDatas = { b : [], s : [] };
			var i = 0,iLen = a.length,io;
			for(;i<iLen;++i){
				io = a[ i ];

				var b = { name: io.nm, cd : io.cd, value: io.total[ "b" ], children: []	};
				
				var k,ko;
				for( s in io.trs ){
					ko = io.trs[ s ];
					b.children.push({ name: s, value: ko.b, children: [] });
				}
				chartDatas.b.push( b );

				var s = { name: io.nm, cd : io.cd, value: io.total[ "s" ] * -1,	children: [] };

				var k,ko;
				for( s in io.trs ){
					ko = io.trs[ s ];
					s.children.push({ name: s, value: ko.s * -1, children: [] });
				}
				chartDatas.s.push( s );
				cbFcuntion( chartDatas );
			}
		}
	}
	xhr.send();
}


var fTradersBuyTreemap = function( data ){
	
	if( !window.charts ) window.charts = {};	
	var dom = document.getElementById("fTradersBuyTreemap");
	window.charts.fTradersBuyTreemap = echarts.init(dom);

	var app = {};
	var option = {
		title: {
			text: 'ECharts Options',
			subtext: '2016/04',
			left: 'leafDepth'
		},
		tooltip: {},
		series: [
			{
				name: '외국계증권사별 매수현황( 금액 )',
				type: 'treemap',
				width :"100%",height :"100%",
				visibleMin: 300,
				data: data,
				leafDepth: 1,
				label : { formatter: function (params){
						let arr = [	params.name, echarts.format.addCommas(params.value) ];
						return arr.join('\n');
					}
				},
				levels: [
					{ color: ['pink','red'], colorMappingBy: 'value', itemStyle: { borderColor: '#fff', borderWidth: 4, gapWidth: 4 } },
					{ color: ['pink','red'], colorMappingBy: 'value', itemStyle: { borderColorSaturation: 0.7, gapWidth: 2, borderWidth: 2 } },
				]
			}
		]
	};

	if (option && typeof option === 'object') {
		window.charts.fTradersBuyTreemap.setOption(option);
		window.charts.fTradersBuyTreemap.on('dbclick',function(d){
			var a = window.document.createElement( "a" );
				a.target = "_blank";
				a.href = "/html/candle.html?cd=" + d.data.cd
				a.click();
		})
	}
}

var fTradersSellTreemap = function(data){

	if( !window.charts ) window.charts = {};	
	var dom = document.getElementById("fTradersSellTreemap");
	window.charts.fTradersSellTreemap = echarts.init(dom);
	var app = {};

	var option = {
		title: {
			text: 'ECharts Options',
			subtext: '2016/04',
			left: 'leafDepth'
		},
		tooltip: {},
		series: [
			{
				name: '외국계증권사별 매도현황( 금액 )',
				type: 'treemap',
				width :"100%",height :"100%",
				visibleMin: 300,
				data: data,
				leafDepth: 1,
				label : { formatter: function (params){
						let arr = [	params.name, echarts.format.addCommas(params.value) ];
						return arr.join('\n');
					}
				},
				levels: [
					{ color: ['skyblue','blue'], colorMappingBy: 'value', itemStyle: { borderColor: '#fff', borderWidth: 4, gapWidth: 4 } },
					{ color: ['skyblue','blue'], colorMappingBy: 'value', itemStyle: { borderColorSaturation: 0.7, gapWidth: 2, borderWidth: 2 } },
				]
			}
		]
	};


	if (option && typeof option === 'object') {
		window.charts.fTradersSellTreemap.setOption(option);
		window.charts.fTradersSellTreemap.on('dbclick',function(d){
			var a = window.document.createElement( "a" );
				a.target = "_blank";
				a.href = "/html/candle.html?cd=" + d.data.cd
				a.click();
		})
	}
}

window.onload = function(){ 

	var params = window.UTIL.Url.paramToObject()
	window.date = {};
	window.date.curDate = params.date;
debugger;
	getTradersData( function(d){
		fTradersBuyTreemap( d.b );
		fTradersSellTreemap( d.s );
	})
	
}
</script>

<body style="padding:50px">

	
<div class="ui one column grid">
  <div class="column"><p id="div00">외국계증권사 매매동향</p></div>
  <div class="column" style="height:400px"><div id="fTradersBuyTreemap" style="width:100%;height: 100%"></div></div>
  <div class="column" style="height:400px"><div id="fTradersSellTreemap" style="width:100%;height: 100%"></div></div>
</div>

</body>

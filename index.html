<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/semantic-ui@2.4.2/dist/semantic.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" referrerpolicy="no-referrer"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.0/dist/echarts.min.js"></script>
<style>
td{
	font-size:11px;
	padding:10px;
}
.ui.card, .ui.cards>.card{

	border-radius: 0rem !important;
	-webkit-box-shadow: 0 0px 0px 0 #d4d4d5, 0 0 0 0px #d4d4d5 !important;
	box-shadow: 0 0px 0px 0 #d4d4d5, 0 0 0 0px #d4d4d5 !important;


}
.ui.card>:first-child, .ui.cards>.card>:first-child {
    border-radius: 0rem 0rem 0 0!important;
    border-top: none!important;
}
th{
	font-size:11px;
}
</style>


<script>
/*
 *
 */
var numberWithCommas = function(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}
/*
 *
 */
var getTimeTo__HHMMSS = function(date){
	
	date = date || new Date();
	//var year = date.getFullYear();
	//var month = date.getMonth() + 1;
	//var day = date.getDate();
	var hour = date.getHours();
	var minute = date.getMinutes();
	var second = date.getSeconds();

	//month = month >= 10 ? month : '0' + month;
	//day = day >= 10 ? day : '0' + day;
	hour = hour >= 10 ? hour : '0' + hour;
	minute = minute >= 10 ? minute : '0' + minute;
	second = second >= 10 ? second : '0' + second;
	var r = ( hour + minute + second ) * 1;

	return r

}
/*
 *
 */
var getTimeTo__YYYYMMDD = function(date){
	
	date = date || new Date();
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
//	var hour = date.getHours();
//	var minute = date.getMinutes();
//	var second = date.getSeconds();

	month = month >= 10 ? month : '0' + month;
	day = day >= 10 ? day : '0' + day;
	//hour = hour >= 10 ? hour : '0' + hour;
	//minute = minute >= 10 ? minute : '0' + minute;
	//second = second >= 10 ? second : '0' + second;
	var r = year + month + day

	return r

}

var getTimeTo__YYYYMMDD_HHMMSS = function(date){
	
	date = date || new Date();
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
	var hour = date.getHours();
	var minute = date.getMinutes();
	var second = date.getSeconds();

	month = month >= 10 ? month : '0' + month;
	day = day >= 10 ? day : '0' + day;
	hour = hour >= 10 ? hour : '0' + hour;
	minute = minute >= 10 ? minute : '0' + minute;
	second = second >= 10 ? second : '0' + second;
	var r = year + "-" + month + "-" + day + " " + hour + ":" + minute+ ":" + second

	return r

}

var getTimeTo__HHMMSS = function(date){
	
	date = date || new Date();
	//var year = date.getFullYear();
	//var month = date.getMonth() + 1;
	//var day = date.getDate();
	var hour = date.getHours();
	var minute = date.getMinutes();
	var second = date.getSeconds();

	//month = month >= 10 ? month : '0' + month;
	//day = day >= 10 ? day : '0' + day;
	hour = hour >= 10 ? hour : '0' + hour;
	minute = minute >= 10 ? minute : '0' + minute;
	second = second >= 10 ? second : '0' + second;
	//var r = year + "-" + month + "-" + day + " " + hour + ":" + minute+ ":" + second
	var r =  hour.toString() + minute.toString() + second.toString()
	return r*1

}

/*
 *
 */
var getTimeTo__YYYY_MM_DD = function(date){
	
	date = date || new Date();
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var day = date.getDate();
//	var hour = date.getHours();
//	var minute = date.getMinutes();
//	var second = date.getSeconds();

	month = month >= 10 ? month : '0' + month;
	day = day >= 10 ? day : '0' + day;
	//hour = hour >= 10 ? hour : '0' + hour;
	//minute = minute >= 10 ? minute : '0' + minute;
	//second = second >= 10 ? second : '0' + second;
	var r = year + "-" + month + "-" + day

	return r

}

var hex = function(c) {
	var s = "0123456789abcdef";
	var i = parseInt (c);
	if (i == 0 || isNaN (c))
	return "00";
	i = Math.round (Math.min (Math.max (0, i), 255));
	return s.charAt ((i - i % 16) / 16) + s.charAt (i % 16);
}

var convertToHex = function(rgb) {
  return hex(rgb[0]) + hex(rgb[1]) + hex(rgb[2]);
}

var trim = function(s) { return (s.charAt(0) == '#') ? s.substring(1, 7) : s }

var convertToRGB = function(hex) {
  var color = [];
  color[0] = parseInt ((trim(hex)).substring (0, 2), 16);
  color[1] = parseInt ((trim(hex)).substring (2, 4), 16);
  color[2] = parseInt ((trim(hex)).substring (4, 6), 16);
  return color;
}

var generateColor = function(colorStart,colorEnd,value){

	// The beginning of your gradient
	var start = convertToRGB (colorStart);    

	// The end of your gradient
	var end   = convertToRGB (colorEnd);    

	// The number of colors to compute
	//var len = colorCount;

	//Alpha blending amount
	var alpha = 0.0;

	alpha = value / 30//window.MassTrd.maxCnt
	var c = [];
	//alpha =value + (1.0/len);
		
	c[0] = start[0] * alpha + (1 - alpha) * end[0];
	c[1] = start[1] * alpha + (1 - alpha) * end[1];
	c[2] = start[2] * alpha + (1 - alpha) * end[2];

	return convertToHex (c);
	
}

var htmlToElement = function( html ){
    var template = document.createElement('template');
    html = html.trim(); // Never return a text node of whitespace as the result
    template.innerHTML = html;
    return template.content.firstChild;
}

var updateRank = function(){

	var xhr = new XMLHttpRequest();

	xhr.open("GET" , `http://112.144.208.118:8888/getMassTradRank_b?date=${window.date.curDate}`, true);
	xhr.onreadystatechange = function(){
		
		if( xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText )
			window.socketData.updateRank = d
			renderUpdateRank();
		}
	}

	xhr.send();

}

window.wsFns = {};

window.wsFns.renderUpdateRank = function(){
	
	var domId = "tree";
	var d = window.socketData.updateRank;
	var dom = document.getElementById( domId );
	if( !window.treemapChart ) 
	{
		window.treemapChart = echarts.init(dom);
		window.treemapChart.isEvent = 0;
	}
	
	//window.treemapChart.showLoading()
	if( d.length == 0 ) return;
	var chartData = [];
	d.sort(function(a,b){ return a.total_pp - b.total_pp }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;
	
	var i =0,iLen = 100,io;
	for(;i<iLen;++i){
		io = d[i]
		
		if( !window.socketData.renderMassTransInfo_sell[io._id] ) var so00 = 0;
		var so00 = window.socketData.renderMassTransInfo_sell[io._id].total_pp

		var symbol = "▲"
		if( io.rt == 0 ) var symbol = "-"
		if( io.rt < 0 ) var symbol = "▼"
		debugger;
		var _o = {
			name : io.nm
			,cd : io._id
			,value : io.total_pp
			,s : so00
			,p : io.p
			,r : io.rt
			,r_mark : symbol
			,pp : io.total_pp - so00
			,children : []
		}
		chartData.push( _o )
	}

	var h = dom.style.height.replace("px") * 1
	var app = {};
	
	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 대량매수 현황";
	option = {
		title : { show : false, text : title,textStyle : { fontSize:13 } },
		grid : { top : 0 },
	  	series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData,
			label : { 
				formatter: function(params){ 
				let arr = [ 
					"{title|" + params.name + "}",
					"{hr|}",
					"{a|" + echarts.format.addCommas(params.data.p) + " " + params.data.r_mark + echarts.format.addCommas(params.data.r) + "%}",			
					"{hr|}",
					"{a|+" + echarts.format.addCommas(params.value) + "}",				
					"{a|-" + echarts.format.addCommas(params.data.s) + "}",
					"{hr|}",
					"{b|" + echarts.format.addCommas(params.data.pp) + "}",
				];
				return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			levels: [{ color: ['pink','red'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
		window.treemapChart.setOption(option);
		window.treemapChart.resize();

		//setTimeout(function(){
		//	//window.treemapChart.hideLoading();
		//},1000)
	}
	
	if( !window.treemapChart.isEvent )
	{
		window.treemapChart.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart.isEvent = 1;
	}
}

window.wsFns.renderUpdateRank_sell = function(){
	
	var domId = "tree_00";
	var d = window.socketData.updateRank_sell;
	var dom = document.getElementById( domId );
	if( !window.treemapChart_00 )
	{
		window.treemapChart_00 = echarts.init(dom);
		window.treemapChart_00.isEvent = 0;
	}
	
	//window.treemapChart_00.showLoading()

	var chartData = [];
	d.sort(function(a,b){ return a.total_pp - b.total_pp }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;

	var i =0,iLen = 100,io;
	for(;i<iLen;++i){
		io = d[i]

		var _o = {
			name : io.nm
			,cd : io._id
			,value : io.total_pp
			//,s : so00.total_pp
			//,pp : io.total_pp - so00.total_pp
			,children : []
		}
		chartData.push( _o )
	}
	var h = dom.style.height.replace("px") * 1
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 대량매도 현황";
	option = {
		title : { show : false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData,
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				"{hr|}",
				"{b|-" + echarts.format.addCommas(params.value) + "}",				
				//"{a|-" + echarts.format.addCommas(params.data.s) + "}",
				//"{hr|}",
				//"{b|" + echarts.format.addCommas(params.data.pp) + "}",

			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			levels: [{ color: ['lightblue','blue'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
	window.treemapChart_00.setOption(option);
	window.treemapChart_00.resize();

	//setTimeout(function(){
	//	//window.treemapChart_00.hideLoading();
	//},1000)
	}

	if( !window.treemapChart_00.isEvent )
	{
		window.treemapChart_00.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart_00.isEvent = 1;
	}

}

window.wsFns.renderUpdateRank_pp = function(){
	
	var domId = "tree_01";
	
	var dom = document.getElementById( domId );
	if( !window.treemapChart_01 )
	{
		window.treemapChart_01 = echarts.init(dom);
		window.treemapChart_01.isEvent = 0;
	}
	
	//window.treemapChart_00.showLoading()

	var chartData = [];
	
	//d.sort(function(a,b){ return a.total_pp - b.total_pp }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;
	
	var s,so;
	for( s in window.socketData.renderMassTransInfo_buy ){
		so = window.socketData.renderMassTransInfo_buy[s]
		if( !window.socketData.renderMassTransInfo_sell[s] ) continue;
		so00 = window.socketData.renderMassTransInfo_sell[s]
		if( so.total_pp - so00.total_pp < 0 ) continue;
		
		//"EVEN" : {	color:"grey", symbol : "-",},
		//"RISE" : {	color:"red", symbol : "▲",},
		//"FALL" : {	color:"blue", symbol : "▼",},
		//"UPPER_LIMIT" : {	color:"red", symbol : "▲",},

		var symbol = "▲"
		if( so.rt == 0 ) var symbol = "-"
		if( so.rt < 0 ) var symbol = "▼"

		var _o = {
			name : so.nm
			,cd : so.cd
			,value : so.total_pp - so00.total_pp
			,p : so.price
			,r : so.rt
			,r_mark : symbol
			,b : so.total_pp
			,s : so00.total_pp
			,children : []
		}
		chartData.push( _o )
	}
	var h = dom.style.height.replace("px") * 1
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 대량거래 누적순매수 현황";
	option = {
		title : { show : false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData,
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				"{hr|}",
				"{a|" + echarts.format.addCommas(params.data.p) + " " + params.data.r_mark + echarts.format.addCommas(params.data.r) + "%}",			
				"{hr|}",
				"{a|+" + echarts.format.addCommas(params.data.b) + "}",				
				"{a|-" + echarts.format.addCommas(params.data.s) + "}",
				"{hr|}",
				"{b|" + echarts.format.addCommas(params.value) + "}",

			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			levels: [{ color: ['lightgreen','green'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
	window.treemapChart_01.setOption(option);
	window.treemapChart_01.resize();

	//setTimeout(function(){
	//	//window.treemapChart_01.hideLoading();
	//},1000)
	}

	if( !window.treemapChart_01.isEvent )
	{
		window.treemapChart_01.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart_01.isEvent = 1;
	}

}

window.wsFns.renderUpdateRank_rt = function(){
	var domId = "rank_rt";
	
	var dom = document.getElementById( domId );
	if( !window.treemapChart_02 )
	{
		window.treemapChart_02 = echarts.init(dom);
		window.treemapChart_02.isEvent = 0;
	}
	
	//window.treemapChart_02.showLoading()

	var _chartData = [];
	
	//d.sort(function(a,b){ return a.rt - b.rt }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;
	
	var s,so;
	for( s in window.socketData.renderMassTransInfo_buy ){
		so = window.socketData.renderMassTransInfo_buy[s]
		if( !window.socketData.renderMassTransInfo_sell[s] ) continue;
		so00 = window.socketData.renderMassTransInfo_sell[s]
		if( so.total_pp - so00.total_pp < 0 ) continue;
		
		//"EVEN" : {	color:"grey", symbol : "-",},
		//"RISE" : {	color:"red", symbol : "▲",},
		//"FALL" : {	color:"blue", symbol : "▼",},
		//"UPPER_LIMIT" : {	color:"red", symbol : "▲",},

		var symbol = "▲"
		if( so.rt == 0 ) var symbol = "-"
		if( so.rt < 0 ) var symbol = "▼"

		var _o = {
			name : so.nm
			,cd : so.cd
			,value : 100 + ( so.rt * 0.001)
			,p : so.price
			,r : so.rt
			,r_mark : symbol
			,b : so.total_pp
			,s : so00.total_pp
			,children : []
		}
		_chartData.push( _o )
	}
	var h = dom.style.height.replace("px") * 1
	var chartData = _chartData.sort(function(a,b){ return a.r - b.r }).reverse();
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 대량거래 누적순매수 현황";
	option = {
		title : { show :false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData.slice(0,100),
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				"{hr|}",
				"{a|" + echarts.format.addCommas(params.data.p) + " " + params.data.r_mark + echarts.format.addCommas(params.data.r) + "%}",			
				"{hr|}",
				"{a|+" + echarts.format.addCommas(params.data.b) + "}",				
				"{a|-" + echarts.format.addCommas(params.data.s) + "}",
				"{hr|}",
				"{b|" + echarts.format.addCommas(params.data.b - params.data.s) + "}",

			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			levels: [{ color: ['pink','red'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
	window.treemapChart_02.setOption(option);
	window.treemapChart_02.resize();

	//setTimeout(function(){
	//	//window.treemapChart_02.hideLoading();
	//},1000)
	}

	if( !window.treemapChart_02.isEvent )
	{
		window.treemapChart_02.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart_02.isEvent = 1;
	}

	

}
window.wsFns.renderTradeValueRank = function(){
	if( window.socketData.renderTradeValueInfo.length == 0 ) return;
	
	var domId = "tradeValueTree";
	
	var dom = document.getElementById( domId );
	if( !window.treemapChart_03 )
	{
		window.treemapChart_03 = echarts.init(dom);
		window.treemapChart_03.isEvent = 0;
		window.treemapChart_03.showLoading();
	}

	var _chartData = [];
	
	//d.sort(function(a,b){ return a.rt - b.rt }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;
	
	var i = 0,iLen = window.socketData.renderTradeValueInfo.length,so;
	for(;i<iLen;++i){
		so = window.socketData.renderTradeValueInfo[i]
		
		var symbol = "▲"
		if( so.rt == 0 ) 
		{
			var symbol = "-"
		}
		if( so.rt < 0 ) 
		{
			var symbol = "▼"	
		}
		var _o = {
			name : so.nm
			,cd : so.cd
			,value : so.rt
			,price : so.price
			,rt : so.rt
			,r_mark : symbol
			,tradeValue : so.tradeValue
			,amt : so.amt
			,children : []
		}
		_chartData.push( _o )
	}
	var h = dom.style.height.replace("px") * 1 - 0
	var chartData = _chartData.sort(function(a,b){ return a.rt - b.rt }).reverse();
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 거래대금";
	option = {

		title : { show :false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData.slice(0,300),
//			data : chartData,
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				"{hr|}",
				"{a|" + echarts.format.addCommas(params.data.price) + " " + params.data.r_mark + echarts.format.addCommas(params.data.rt) + "%}",			
				"{hr|}",
				"{b|" + longNumberAddString( params.data.tradeValue) + "}",
				//"{a|" + echarts.format.addCommas(params.data.amt) + "}",

			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			visualMin : -30,
			visualMax : 30,
			//visualDimension : 1,
			levels: [{ color: ['blue','#ccc','red'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
		window.treemapChart_03.setOption(option);
		window.treemapChart_03.resize();	
	}

	if( !window.treemapChart_03.isEvent )
	{
		setTimeout(function(){ window.treemapChart_03.hideLoading(); },1000)
		window.treemapChart_03.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart_03.isEvent = 1;
	}
}


window.wsFns.renderTradeValueInfo = function(){
	debugger;
	window.wsFns.renderTradeValueRank();
}

window.wsFns.renderTradeValueInfo_gap = function(){
	debugger;
	window.wsFns.renderTradeValueList();
}

var longNumberAddString = function( n ){
	var _p = n.toString().length;
	if( _p == 1 ) return n + "백만"
	if( _p == 2 ) return ( n * 0.1 ).toFixed(1) + "천만"
	if( _p >= 3 ) return ( n * 0.01 ).toFixed(1) + "억"
}
window.wsFns.renderTradeValueList = function(){
	console.log( "[ S ] - window.wsFns.renderTradeValueList" )
	
	if( window.socketData.renderTradeValueInfo_gap.length == 0 ) return;
	
	var domId = "tradeValueTreeGap";
	
	var dom = document.getElementById( domId );
	if( !window.treemapChart_04 )
	{
		window.treemapChart_04 = echarts.init(dom);
		window.treemapChart_04.isEvent = 0;
	}
	
	//window.treemapChart_04.showLoading()

	var _chartData = [];
	var colors = [];
	//d.sort(function(a,b){ return a.rt - b.rt }).reverse()
	//var i =0,iLen = window.socketData.updateRank.length,io;
	
	//var i = 0,iLen = window.socketData.renderTradeValueInfo_gap.length,so;
	var i = 0,iLen = 50,so;
	for(;i<iLen;++i){
		so = window.socketData.renderTradeValueInfo_gap[i]
		
		var symbol = "▲"
		var id = 0
		if( so.rt == 0 ) 
		{
			var symbol = "-"
			var id = 1
		}
		if( so.rt < 0 ) 
		{
			var symbol = "▼"	
			var id = 2
		}

		var _o = {
			name : so.nm
			,cd : so.cd
			,value : [ so.tradeValueGap, so.rtChange ]
			,price : so.price
			,rt : so.rt
			,rtChange : so.rtChange
			,curRt : so.curRt
			,prevRt : so.prevRt
			,r_mark : symbol
			,tradeValue : so.tradeValue
			,tradeValueGap : so.tradeValueGap
			,amt : so.amt
			,children : []
		}
		_chartData.push( _o )
	}
	var h = dom.style.height.replace("px") * 1
	var chartData = _chartData.sort(function(a,b){ return b.tradeValueGap - a.tradeValueGap });
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - 실시간 대량거래 누적순매수 현황";
	option = {
		title : { show :false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : chartData,
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				//"{hr|}",
				"{a|" + echarts.format.addCommas(params.data.price) + " " + params.data.r_mark + echarts.format.addCommas(params.data.rt) + "%}",			
				"{hr|}",
				"{a|volume:" + echarts.format.addCommas(params.data.amt) + " / value:" + longNumberAddString(params.data.tradeValue) + "}",
				"{a|curRt:" + echarts.format.addCommas(params.data.curRt) + " / prevRt:" + echarts.format.addCommas(params.data.prevRt) + "}",
				"{hr|}",
				"{b|" + longNumberAddString( params.data.tradeValueGap ) + "(" + echarts.format.addCommas(params.data.rtChange.toFixed(2)) + "%)}",

			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			visualMin : -1,
			visualMax : 1,
			visualDimension : 1,
			levels: [{ color: ['blue','#999','red'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
	window.treemapChart_04.setOption(option);
	window.treemapChart_04.resize();

	//setTimeout(function(){ window.treemapChart_04.hideLoading(); },1000)
	
	}

	if( !window.treemapChart_04.isEvent )
	{
		window.treemapChart_04.on('click',function(d){
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + d.data.cd
			a.click();
			a = null;
		})
		window.treemapChart_04.isEvent = 1;
	}
	console.log( "[ E ] - window.wsFns.renderTradeValueList" )
}

window.wsFns.renderMassTransInfo_buy = function(){
	//if( Object.keys( window.wsFns.renderMassTransInfo_buy.cur ).keys.length == 0 )
	//{
	//	window.wsFns.renderMassTransInfo_buy.prev = window.socketData.renderMassTransInfo_buy
	//	window.wsFns.renderMassTransInfo_buy.cur = window.socketData.renderMassTransInfo_buy
	//}
	//else
	//{
		debugger;
		window.a = window.b
		window.b = window.socketData.renderMassTransInfo_buy
	//}
	window.wsFns.renderMassTransList_buy();
	
}
window.wsFns.renderMassTransInfo_buy.prev = {}
window.wsFns.renderMassTransInfo_buy.prev._t = ""

window.wsFns.renderMassTransInfo_buy.cur = {}
window.wsFns.renderMassTransInfo_buy.cur._t = ""

window.wsFns.renderMassTransInfo_sell = function(){

	if( Object.keys( window.wsFns.renderMassTransInfo_sell.cur ).length == 0 )
	{
		window.wsFns.renderMassTransInfo_sell.cur = window.socketData.renderMassTransInfo_sell
		window.wsFns.renderMassTransInfo_sell.prev = window.socketData.renderMassTransInfo_sell
	}
	else
	{
		window.wsFns.renderMassTransInfo_sell.cur = window.socketData.renderMassTransInfo_sell
		window.wsFns.renderMassTransInfo_sell.prev = window.wsFns.renderMassTransInfo_sell.cur
	}
}
window.wsFns.renderMassTransInfo_sell.prev = {}
window.wsFns.renderMassTransInfo_sell.cur = {}



window.massTransData={}
window.massTransData.buy = {};

window.massTransData.buy.prev = ""

window.wsFns.renderMassTransList_buy = function(){
	console.log( "[ S ] - window.wsFns.renderMassTransList_buy" )
	

	var prevData = window.a;
	var curData = window.b;

	var s,o;
	for( s in curData )
	{
		o = curData[ s ]

	if( !window.massTransData.buy[ o.cd ] ) window.massTransData.buy[ o.cd ] = { cnt : 1 }
	else ++window.massTransData.buy[ o.cd ].cnt;
		
		//console.log( s )
		if( o._t != prevData[s]._t ) debugger;
		if( o.total_pp == prevData[ s ].total_pp ) continue
		else console.log( "여기당" )
		var color00 = "red"
		if( o.rt < 0 ) color00 = "blue"
		if( o.rt == 0 ) color00 = "gery"

		var color = generateColor('#FF0000','#cccccc',o.rt)				
		 var _html = `
		 <div class="card" style="padding: 10px;box-shadow: 0 1px 1px 0 #ccc, 0 0 0 1px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;" id="mass_b_00_${o.cd}" data-cd-value="${o.cd}" data-nm-value="${o.nm}" data-cnt-value="${window.massTransData.buy[ o.cd ].cnt}">
			<div class="">
			<div class="right floated meta" style="position: relative;color: #${color};padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${window.massTransData.buy[ o.cd ].cnt}</div>
			<span style="font-size:15px;"> ${o.nm}</span><span style="font-size:11px;">  ${o.cd}</span> 	
			<div style="font-size:13px;color:${color00}">${numberWithCommas(o.price)} ( ${o.rt}% )</div>
			<div style="font-size:13px;">value : ${numberWithCommas( o.pp )}</div>
			<div style="font-size:11px;">
			+ ${window.socketData.renderMassTransInfo_buy[ o.cd ].total_pp} / 
			- ${window.socketData.renderMassTransInfo_sell[ o.cd ].total_pp} / 
			${window.socketData.renderMassTransInfo_buy[ o.cd ].total_pp - window.socketData.renderMassTransInfo_sell[ o.cd ].total_pp}
			</div>
			<div style="font-size:11px;">
			f : ${window.massTransData.buy[ o.cd ]._t} / u : ${window.massTransData.buy[ o.cd ]._t00}
			</div>
			</div>

			<div class="image" style="background-color: #fff/*${color}*/;">
				<!--div style="position: relative;color: #fff;padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${window.massTransData.buy[ o.cd ].cnt}</div-->
				<img src="https://t1.daumcdn.net/finance/chart/kr/stock/d/A${o.cd}.png" style="" load="lazy">
				
			</div>
			<!--div class="description">
			<div style="font-size:11px;padding-top:10px;"> volume : ${o.amt} / value : ${numberWithCommas( o.pp )}</div>
			</div-->
			</div>
			
		 </div>
		`
		

		var new_el = htmlToElement( _html )
		var target_el = window.document.getElementById( "mass_b_00_" + o.cd )
		
		if( target_el )
		{
			window._el.id_mass_b_s.removeChild( target_el )
			window._el.id_mass_b_s.insertBefore( new_el,window._el.id_mass_b_s.firstChild )
		}
		else
		{
			if( window._el.id_mass_b_s.childElementCount == 10 )
			{
				window._el.id_mass_b_s.removeChild( window._el.id_mass_b_s.lastChild )		
			}
			window._el.id_mass_b_s.insertBefore( new_el,window._el.id_mass_b_s.firstChild )	
		}
		
		new_el.addEventListener( "click",function(e){

		var cd = e.currentTarget.getAttribute( "data-cd-value" );
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = "/html/candle.html?cd=" + cd
		a.click();
		a = null;
		
		})

	}
	
	console.log( "[ E ] - window.wsFns.renderMassTransList_buy" )
}
window.wsFns.renderMassTransList_buy.cnt = 0;
window.wsFns.renderMassTransList_buy.isProcessing = 0;

window.treemapChart00 = {};
window.treemapChart00.isEvent = 0;
window.treemapChart00.isReq = 0;
var updateRankWics = function(){

		var xhr = new XMLHttpRequest();
		
		xhr.open("GET" , `http://112.144.208.118:8888/getWicsData`, true);
		xhr.onreadystatechange = function(){
			
			if( xhr.readyState == 4 && xhr.status == 200)
			{
				
				var d = JSON.parse( xhr.responseText )
				renderTreemapWics( d.data )
								
			}
		}

		xhr.send();
	
}

var renderTreemapWics = function( d ){
	
	console.log( "[ S ] - renderTreemapWics" )
	
	if( d.length == 0 ) return;
	
	var domId = "wicsTree";
	
	var dom = document.getElementById( domId );
	if( !window.treemapChart_wics )
	{
		window.treemapChart_wics = echarts.init(dom);
		window.treemapChart_wics.isEvent = 0;
	}
	
	//window.treemapChart_wics.showLoading()
	
	var min = 0;
	var max = 0;
	var _chartData = [];
	var i = 0,iLen = d.length,io;
	for(;i<iLen;++i){
		io = d[i]
		
		var symbol = "▲"
		if( io.rt == 0 ) var symbol = "-"
		if( io.rt < 0 ) var symbol = "▼"
		
		if( min > io.changeRate ) min = io.changeRate;
		if( max < io.changeRate ) max = io.changeRate;

		var _o = {
			name : io.sectorName
			, cd : io.sectorCode
			, value : [ io.changeRate + 30, io.changeRate ]
			, accTradePrice : io.accTradePrice
			, accTradeVolume : io.accTradeVolume
			, changeRate : io.changeRate
			, children : []
		}
		_chartData.push( _o )
	}

	var h = dom.style.height.replace("px") * 1 - 0
	
	var app = {};

	var option;
	var nowDate = getTimeTo__YYYYMMDD_HHMMSS()
	var title = nowDate + " - WICS 업종별 현황";
	option = {
		title : { show :false, text : title,textStyle : { fontSize:13 } },
		grid : { top:0 },
		series: [
			{ type: 'treemap', leafDepth: null, roam: true, nodeClick: false,
			breadcrumb : { show : false, },
			width :"100%",
			height :h,
			top:0,
			data : _chartData,
			label : { formatter: function (params) { 
			let arr = [ "{title|" + params.name + "}",
				"{hr|}",
				"{a|" + echarts.format.addCommas(params.data.accTradePrice) + "}",
				"{a|" + echarts.format.addCommas(params.data.accTradeVolume) + "}",			
				"{hr|}",
				"{b|" + ( params.data.changeRate * 100 ).toFixed(2) + "%}",
			];
			return arr.join('\n');
			}
			, rich : {
				title : { fontSize: 14 },
				a : { fontSize: 9 },
				b : { fontSize: 12 },
				hr : { 
					width : "100%",
					borderColor : "rgba(255,255,255,0.0)",
					borderWidth : 0.5,
					height : 0,
					lineHeight : 10,
				}
			}
			},
			visualMin : min,
			visualMax : max,
			visualDimension : 1,
			levels: [{ color: ['blue','#999','red'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
		}
		]
	};

	if( option && typeof option === 'object' ){
	window.treemapChart_wics.setOption(option);
	window.treemapChart_wics.resize();

	//setTimeout(function(){ window.treemapChart_wics.hideLoading(); },1000)
	
	}

	if( !window.treemapChart_wics.isEvent )
	{
		window.treemapChart_wics.on('click',function(d){
			
			getWicsDataByCd( d.data.cd );
			
		})
		window.treemapChart_wics.isEvent = 1;
	}
	console.log( "[ E ] - renderTreemapWics" )


}


var getWicsDataByCd = function( cd ){
		
	var xhr = new XMLHttpRequest();
	
	xhr.open("GET" , `http://112.144.208.118:8888/getWicsDataByCd?cd=${cd}`, true);
	xhr.onreadystatechange = function(){
		
		if( xhr.readyState == 4 && xhr.status == 200)
		{
			
			var d = JSON.parse( xhr.responseText )
			window._el.id_wics_stocks.innerHTML = ""	
			var i = 0,iLen = d.length,io;
			for(;i<iLen;++i){
				io = d[ i ];
				insertWicsStockData( io );
			}
			
		}
	}

	xhr.send();

}

var insertWicsStockData = function( o ){


	var status = {
		"EVEN" : {	color:"grey", symbol : "-",},
		"RISE" : {	color:"red", symbol : "▲",},
		"FALL" : {	color:"blue", symbol : "▼",},
		"UPPER_LIMIT" : {	color:"red", symbol : "▲",},
	}
	
	//var color = generateColor('#FF0000','#cccccc',o.rt)				
	 var _html = `
		 <div class="card" style="padding: 5px!important;box-shadow: 0 1px 1px 0 #ccc, 0 0 0 1px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;" id="mass_b_00_${o.symbolCode}" data-cd-value="${o.symbolCode.replace("A","")}" data-nm-value="${o.name}">
			<div class="content">
				<span style="font-size:15px;"> ${o.name}</span><span style="font-size:11px;">  ${o.symbolCode}</span> 	
				<div style="font-size:16px;color:${status[ o.change ].color}">${numberWithCommas(o.tradePrice)} 
					<span style="font-size:12px;color:${status[ o.change ].color}">${status[ o.change ].symbol} ${o.changePrice}( ${ ( o.changeRate * 100 ).toFixed(2)}% )</span>
				</div>
			</div>
			
			<div class="image" style="padding: 5px;background-color: #fff/*red*/;">
		 		<img src="https://t1.daumcdn.net/finance/chart/kr/stock/d/A${o.symbolCode.replace("A","")}.png" style="" load="lazy">
		 	</div>

			<!--div class="description"></div-->
		 </div>
		`

		var new_el = htmlToElement( _html )
		


		//*/
		
		
		window._el.id_wics_stocks.appendChild( new_el )	
		

		new_el.addEventListener( "click",function(e){
			var cd = e.currentTarget.getAttribute( "data-cd-value" )
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + cd
			a.click();
			
		})	

}

window.wsFns.getMarketIndex = function( cbFunction ){
		
	var xhr = new XMLHttpRequest();
	
	xhr.open("GET" , `http://112.144.208.118:8888/getMarketIndex`, true);
	xhr.onreadystatechange = function(){
		
		if( xhr.readyState == 4 && xhr.status == 200)
		{
			
			var d = JSON.parse( xhr.responseText )
			window.socketData.MarketIndex = d;
			window.wsFns.renderMarketIndex()
			cbFunction();
			
		}
	}
	
	xhr.send();

}

window.wsFns.renderMarketIndex = function(){
	//window._el.id_market_index.innerHTML = "";
	var status = {
		//"EVEN" : {	color:"grey", symbol : "-",},
		"RISING" : {	color:"red", symbol : "▲",},
		"FALLING" : {	color:"blue", symbol : "▼",},
		//"UPPER_LIMIT" : {	color:"red", symbol : "▲",},
	}
	var _html = "";
	var i = 0,iLen = window.socketData.MarketIndex.datas.length,io;
	for(;i<iLen;++i){
		io = window.socketData.MarketIndex.datas[ i ];
		//var color = generateColor('#FF0000','#cccccc',o.rt)				
		_html += `
			<div class="card" style="padding: 5px!important;box-shadow: 0 1px 1px 0 #ccc, 0 0 0 1px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;" id="market_index_${io.symbolCode}" data-cd-value="${io.symbolCode}" data-nm-value="${io.stockName}">
				<div class="content">
					<span style="font-size:15px;"> ${io.symbolCode}</span> - <span style="font-size:11px;">  ${io.marketStatus}</span> 	
					<div style="font-size:16px;color:${status[ io.compareToPreviousPrice.name ].color}">${numberWithCommas(io.closePrice)} 
						<span style="font-size:12px;color:${status[ io.compareToPreviousPrice.name ].color}">${status[ io.compareToPreviousPrice.name ].symbol} ${io.compareToPreviousClosePrice}( ${ io.fluctuationsRatio}% )</span>
					</div>
				</div>
				
				<div class="image" style="padding: 5px;background-color: #fff/*red*/;">
					<img src="https://ssl.pstatic.net/imgfinance/chart/main/${io.symbolCode}.png" style="" load="lazy">
				</div>

				<!--div class="description"></div-->
			</div>
			`

			//var new_el = htmlToElement( _html )
			//window._el.id_market_index.appendChild( new_el )
	}
	window._el.id_market_index.innerHTML = _html
}

window.wsFns.getMarketIndexGlobal = function(){
		
		var xhr = new XMLHttpRequest();
		
		xhr.open("GET" , `http://112.144.208.118:8888/getMarketIndexGlobal`, true);
		xhr.onreadystatechange = function(){
			
			if( xhr.readyState == 4 && xhr.status == 200)
			{
				debugger;
				
				var d = JSON.parse( xhr.responseText )
				window.socketData.MarketIndexGlobal = d;
				//window._el.id_market_index.innerHTML = "";
				window.wsFns.renderMarketIndexGlobal();
				
			}
		}
		
		xhr.send();
	
	}
window.wsFns.renderMarketIndexGlobal = function(){
	var status = {
		"UNCHANGED" : {	color:"grey", symbol : "-",},
		"RISING" : {	color:"red", symbol : "▲",},
		"FALLING" : {	color:"blue", symbol : "▼",},
		//"UPPER_LIMIT" : {	color:"red", symbol : "▲",},
	}

	// var i = 0,iLen = window.socketData.MarketIndexGlobal.north_america.data.length,io;
	// for(;i<iLen;++i){
	// 	io = window.socketData.MarketIndexGlobal.north_america.data[ i ];
		
	// 	//var color = generateColor('#FF0000','#cccccc',o.rt)				
	// 	var _html = `
	// 		<div class="card" style="padding: 5px!important;box-shadow: 0 1px 1px 0 #ccc, 0 0 0 1px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;" id="market_index_${io.symbolCode}" data-cd-value="${io.symbolCode}" data-nm-value="${io.name}">
	// 			<div class="content">
	// 				<span style="font-size:15px;"> ${io.name}</span><!--span style="font-size:11px;">  ${io.countryName}</span--> 	
	// 				<div style="font-size:16px;color:${status[ io.change ].color}">${numberWithCommas(io.tradePrice)}<br>
	// 					<span style="font-size:12px;color:${status[ io.change ].color}">${status[ io.change ].symbol} ${io.changePrice}( ${status[ io.change ].mark}${ (( io.changePrice / io.tradePrice ) * 100 ).toFixed(2)}% )</span>
	// 				</div>
	// 			</div>
				
	// 			<div class="image" style="padding: 5px;background-color: #fff/*red*/;">
	// 				<img src="https://t1.daumcdn.net/finance/chart/us/stock/d/${io.symbolCode.split(".")[1]}.png" style="" load="lazy">
	// 			</div>

	// 			<!--div class="description"></div-->
	// 		</div>
	// 		`

	// 		var new_el = htmlToElement( _html )
	// 		window._el.id_market_index.appendChild( new_el )	
	// }

	var _html = "";
	var s,so;
	for( s in window.socketData.MarketIndexGlobal ){
		so = window.socketData.MarketIndexGlobal[ s ];
		if( s != "USA") continue
		var i = 0,iLen = so.length,io;
		for(;i<iLen;++i){
			io = so[ i ];
			//var color = generateColor('#FF0000','#cccccc',o.rt)		
			var name = ""
			//if( io.stockEndType != "futures") continue;
			if( io.stockEndType == "futures") name = io.futuresName;
			else name = io.indexName;
			try
			{
				_html += `
				<div class="card" style="padding: 5px!important;box-shadow: 0 0px 0px 0 #ccc, 0 0 0 0px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;margin:0px!important;" id="market_index_${io.reutersCode}" data-cd-value="${io.reutersCode}" data-nm-value="${io.indexName}">
					<div class="">
						<span style="font-size:13px;"> ${name}</span> - <span style="font-size:11px;">  ${io.marketStatus}</span> 	
						<div style="font-size:16px;color:${status[ io.compareToPreviousPrice.name ].color}">${numberWithCommas(io.closePrice)}  
							<span style="font-size:12px;color:${status[ io.compareToPreviousPrice.name ].color}">${status[ io.compareToPreviousPrice.name ].symbol} ${io.compareToPreviousClosePrice}( ${ io.fluctuationsRatio}% )</span>
						</div>
					</div>
					
					<!--div class="image" style="padding: 5px;background-color: #fff/*red*/;">
						<img src="https://ssl.pstatic.net/imgfinance/chart/mobile/world/day/${io.reutersCode}_end_up.png" style="" load="lazy">
					</div-->

					<!--div class="description"></div-->
				</div>
				`	
			}
			catch( er )
			{
				debugger;
			}
			
			//var new_el = htmlToElement( _html )
			//window._el.id_market_index.appendChild( new_el )	
				
		}
		window._el.id_market_index_1.innerHTML = _html;
		
	}
}
var updateRank_s = function(){

		var xhr = new XMLHttpRequest();
		xhr.open("GET" , `http://112.144.208.118:8888/getMassTradRank_s?date=${window.date.curDate}`, true);
		xhr.onreadystatechange = function(){
			
			if( xhr.readyState == 4 && xhr.status == 200)
			{
				
				var d = JSON.parse( xhr.responseText )
				

				if( d.length == 0 ) return;

				var chartData = [];
				var i =0,iLen = d.length,io;
				for(;i<iLen;++i){
					io = d[i]
					var _o = {
						name : io.nm
						,cd : io._id
						,value : io.total_pp * -1
						,children : []
					}
					chartData.push( _o )
				}
				
				var dom = document.getElementById("tree_s");
				window.treemapChart = echarts.init(dom);
				var app = {};

				var option;

				option = {
				//title : { text : new Date(),top:0,textStyle : { fontSize:13 } },
				grid : { width :"100%" },
				  series: [
					{ type: 'treemap', leafDepth: null, roam: false, nodeClick: false,
					breadcrumb : { show : false, },
					width :"100%",height :"90%",
					data : chartData,
					label : { formatter: function (params) { 
							let arr = [ params.name,echarts.format.addCommas(params.value)];
							return arr.join('\n');
						}
					},
					levels: [{ color: ['skyblue','blue'],colorMappingBy: 'value',itemStyle: {gapWidth: 1}}]
					}
				  ]
				};

				if (option && typeof option === 'object') {
					window.treemapChart.setOption(option);
				}
				if( !window.treemapChart.isEvent )
				{
					window.treemapChart.isEvent = 1;
					window.treemapChart.on('click',function(d){
						debugger;
						var cd = d.data.cd
						var a = window.document.createElement( "a" );
							a.target = "_blank";
							a.href = "/html/candle.html?cd=" + d.data.cd
							a.click();
					})
				}
				setTimeout(function(){ updateRank()  },5000)
			}
		}

		xhr.send();
	
}


window.massStorckCnt = {};
window.massStorckCnt.b = {};
var upadteMassTradDataInsert00 = function( o ){

	var target_el = window.document.getElementById( "mass_b_00_" + o.cd )

	try
	{
		if( !window.massStorckCnt.b[ o.cd ] )
		{
			window.massStorckCnt.b[ o.cd ]= {};
			window.massStorckCnt.b[ o.cd ].cnt = 1;
			window.massStorckCnt.b[ o.cd ].pp = o.pp;
			window.massStorckCnt.b[ o.cd ].instTime = o._t
			
		}
		else
		{
			++window.massStorckCnt.b[ o.cd ].cnt;		
			window.massStorckCnt.b[ o.cd ].pp = window.massStorckCnt.b[ o.cd ].pp + o.pp;
		}

	}
	catch(er)
	{
		debugger;
	}


	var color00 = "red"
	if( o.rt < 0 ) color00 = "blue"
	if( o.rt == 0 ) color00 = "gery"

	if( window.massStorckCnt.b[ o.cd ].pp < 100000000 )
	{
		//console.log(1)
	}
	else
	{
		var color = generateColor('#FF0000','#cccccc',o.rt)				
		 var _html = `
		 <div class="card" style="padding: 10px;box-shadow: 0 1px 1px 0 #ccc, 0 0 0 1px #ccc !important;border-radius: 0rem !important;display:block;cursor:pointer;" id="mass_b_00_${o.cd}" data-cd-value="${o.cd}" data-nm-value="${o.nm}" data-cnt-value="${window.massStorckCnt.b[ o.cd ].cnt}">
			<div class="content">
			<div class="right floated meta" style="position: relative;color: #${color};padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${window.massStorckCnt.b[ o.cd ].cnt}</div>
			<span style="font-size:15px;"> ${o.nm}</span><span style="font-size:11px;">  ${o.cd}</span> 	
			<div style="font-size:13px;color:${color00}">${numberWithCommas(o.price)} ( ${o.rt}% )</div>
			<div style="font-size:13px;">value : ${numberWithCommas( o.pp )}</div>
			</div>
			
			<div class="image" style="background-color: #fff/*${color}*/;">
		 		<!--div style="position: relative;color: #fff;padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${window.massStorckCnt.b[ o.cd ].cnt}</div-->
		 		<img src="https://t1.daumcdn.net/finance/chart/kr/stock/d/A${o.cd}.png" style="" load="lazy">
				
		 	</div>
			<!--div class="description">
			<div style="font-size:11px;padding-top:10px;"> volume : ${o.amt} / value : ${numberWithCommas( o.pp )}</div>
			</div-->
			</div>
			
		 	<!--div style="font-size:11px;">
		 	f : ${window.massStorckCnt.b[ o.cd ].instTime}<br>
		 	u : ${o._t}
			
		 	</div-->
			
		 </div>
		`
		//var _html = `
		//<tr id="mass_b_00_${o.cd}" data-cd-value="${o.cd}" data-nm-value="${o.nm}" data-cnt-value="${window.massStorckCnt.b[ o.cd ].cnt}" style="display:block;cursor:pointer;">
		//	<td class="image" style="width:150px;background-color: #${color};">
		//		<div style="position: relative;color: #fff;padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${window.massStorckCnt.b[ o.cd ].cnt}</div>
		//		<img src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${o.cd}_transparent.png" style="width:150px" load="lazy">
		//	</td>
		//	<td style="width:100%;">
		//		<div><span style="font-size:15px;">${o.nm}</span>( ${o.cd} ) - ${o.type == 1 ? "매수" : "매도"} </div>
		//		<div style="padding:0px 0px 0px 0px">현재가격 : ${numberWithCommas( o.price )}  / 등락률 : ${o.rt}</div>
		//		<div style="padding:10px 0px;">volume : ${o.amt}  / value : ${numberWithCommas( o.pp )}</div>
		//		<div>u : ${o._t}</div>
		//		<div>f : ${window.massStorckCnt.b[ o.cd ].instTime}</div>
		//	</td>
		//</tr>
		//`

		var new_el = htmlToElement( _html )
		


		//*/
		
		var target_el = window.document.getElementById( "mass_b_00_" + o.cd )
		if( target_el )
		{
			window._el.id_mass_b_s.removeChild( target_el )
			window._el.id_mass_b_s.insertBefore( new_el,window._el.id_mass_b_s.firstChild )			
			
		}
		else
		{
			window._el.id_mass_b_s.insertBefore( new_el,window._el.id_mass_b_s.firstChild )	
		}
		/*/
		if( window._el.id_mass_b_s.childElementCount > 100 )
		{
			if( window._el.id_mass_b_s.lastChild )
			{
				window._el.id_mass_b_s.removeChild( window._el.id_mass_b_s.lastChild )	
			}
				
		}
		window._el.id_mass_b_s.insertBefore( new_el,window._el.id_mass_b_s.firstChild )	
		//*/

		new_el.addEventListener( "click",function(e){
			try
			{
				var cd = e.currentTarget.getAttribute("data-cd-value");
				var nm = e.currentTarget.getAttribute("data-nm-value");
				window.barchart_cur = cd;
			
				var title =  nm + " ( " + cd + " ) "
				renderBarChart(cd,title)
				getTotalTradPrice( cd )
				updateStock( cd )
				insertChart00( cd )
				getFTrData( cd )
				getAgcData( cd )
				window._el.id_news.innerHTML = "";
				updateNews( cd )
				updateNewsFromNaver( cd )
				getTrdRank( cd )
				//renderScatterChart( cd, title )

			}
			catch(er)
			{
				debugger;
			}
			
		})	
	}
	setTimeout(function(){
		upadteMassTradDataInsertWatch()
	},300)
}

var upadteMassTradDataInsert = function( o ){
			

	if( o.total != null )
	{
		var total_pp  = o.total.total_pp;
		var cnt = o.total.cnt
		if( !window.MassData.b[ o.cd ] ) window.MassData.b[ o.cd ] = {	
			total_pp : o.total.total_pp, cnt : o.total.cnt,	data : o.total.data
		}	

		window.MassData.b[ o.cd ].data = o;
		window.MassData.b[ o.cd ].total_pp += o.pp
		window.MassData.b[ o.cd ].cnt += 1
	}
	else
	{
		var total_pp  = o.pp;
		var cnt = 1
		if( !window.MassData.b[ o.cd ] ) window.MassData.b[ o.cd ] = {	
			total_pp : total_pp, cnt : cnt,data : o
		}	
	}
	

	var color = generateColor('#FF0000','#cccccc',1)				
	

	/*
	var _html = `
	<div class="card" style="padding: 10px;box-shadow: 0 0px 3px 0 #fff, 0 0 0 3px #fff !important;border-radius: 0rem !important;" id="mass_${o.cd}" data-cd-value="${o.cd}">
		<div class="image">
			<img src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${o.cd}_end_up_tablet.png" load="lazy" >
		</div>
		<div> ${o.nm} <br> ${o._t} <br> ${o.amt}  / ${numberWithCommas( o.pp )} </div>
		<div style="position: absolute; background-color: #${color};color: #fff;padding: 5px;min-width: 30px;text-align: center;">${cnt}</div>
		<div> ${numberWithCommas( total_pp )}</div>
	</div>
	`
	*/
	var _html = `
	<tr id="mass_b_${o.cd}" data-cd-value="${o.cd}">
		<!--td class="image" style="width:150px;background-color: #${color};">
			<div style="position: relative;color: #fff;padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${cnt}</div>
			<!--img src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${o.cd}_transparent.png" style="width:150px" load="lazy"-->
			
		</td-->
		<td> ${o.nm}( ${o.cd} ) <br> ${o._t}<br> ${o.type} <br> ${o.amt}  / ${numberWithCommas( o.pp )} / ${numberWithCommas( total_pp )}</td>
	</tr>
	`
	

	
	var new_el = htmlToElement( _html )
	
	//if( window._el.id_mass_b.childElementCount > 100 ) //window._el.id_mass_b.lastElementChild.parentNode.removeChild( window._el.id_mass_b.lastElementChild )
	//window._el.id_mass_b.insertBefore( new_el,window._el.id_mass_b.firstChild )	

//	var target_el = window.document.getElementById( "mass_b_" + o.cd )
//	if( target_el )
//	{
//		window._el.id_mass_b.lastElementChild.parentNode.removeChild( target_el )
	//	window._el.id_mass_b.insertBefore( new_el,window._el.id_mass_b.firstChild )			
		
	//}
	//else
	//{
		window._el.id_mass_b.insertBefore( new_el,window._el.id_mass_b.firstChild )	
	//}
	

	//if( window.barchart_cur == o.cd )
	//{
	//	renderBarChartAddData( o.pp,o._t, o.type )	
	//}

	new_el.addEventListener( "click",function(e){
		var cd = e.currentTarget.getAttribute("data-cd-value");
		window.barchart_cur = cd;

		var title =  window.MassData.b[ cd ].data.nm + " ( " + cd + " ) "
		//renderBarChart(window.MassData.b[ cd ].data.total.data,title)
		//getFTrData( cd )
		//getAgcData( cd )
		//updateNews( cd )
	})

	setTimeout(function(){
		upadteMassTradDataInsertWatch()
	},300)
			
}
upadteMassTradDataInsertWatch = function(){

	if( window._data.b.length == 0 ) 
	{
		return setTimeout(function(){
				upadteMassTradDataInsertWatch()
		},1000)
	}

	var o = window._data.b.shift();
	upadteMassTradDataInsert00( o )
	//upadteMassTradDataInsert( o );
}


var updateMassTradData = function(){

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , `http://112.144.208.118:8888/getMassTradCheck_b?date=${window.date.curDate}&lidx=${window.MassDataInfo.b}&limit=100`, true);
		xhr.onreadystatechange = function() {
			if(xhr.readyState == 4 && xhr.status == 200)
			{
				var a =JSON.parse(xhr.responseText);
				var  i =0,iLen = a.d.length,io;
				for(;i<iLen;++i){
					io = a.d[ i ]
					window._data.b.push( io )
				}

				if( a.nxtId != -1 ) window.MassDataInfo.b = a.nxtId;

				setTimeout(function(){
					updateMassTradData();	
				},5000)

			}
		}
		xhr.send();
}


















var upadteMassTradDataInsert_s = function( o ){
			
	var cnt = 1
	if( o.total != null )
	{
		var total_pp  = o.total.total_pp;
		var cnt = o.total.cnt
		if( !window.MassData.s[ o.cd ] ) window.MassData.s[ o.cd ] = {	
			total_pp : o.total.total_pp, cnt : o.total.cnt,	data : o.total.data
		}	

		window.MassData.s[ o.cd ].data = o;
		window.MassData.s[ o.cd ].total_pp += o.pp
		window.MassData.s[ o.cd ].cnt += 1
	}
	else
	{
		var total_pp  = o.pp;
		var cnt = 1
		if( !window.MassData.s[ o.cd ] ) window.MassData.s[ o.cd ] = {	
			total_pp : total_pp, cnt : cnt,data : o
		}	
	}
	
	try
	{
		if( o.total.cnt == null	)
		{
			var color = generateColor('#0072df','#cccccc',1)				
		}
		else
		{
			var color = generateColor('#0072df','#cccccc',o.total.cnt)				
		}

	}
	catch(er)
	{
		debugger;
	}
	
	/*
	var _html = `
	<div class="card" style="padding: 10px;box-shadow: 0 0px 3px 0 #fff, 0 0 0 3px #fff !important;border-radius: 0rem !important;" id="mass_${o.cd}" data-cd-value="${o.cd}">
		<div class="image">
			<img src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${o.cd}_end_up_tablet.png" load="lazy" >
		</div>
		<div> ${o.nm} <br> ${o._t} <br> ${o.amt}  / ${numberWithCommas( o.pp )} </div>
		<div style="position: absolute; background-color: #${color};color: #fff;padding: 5px;min-width: 30px;text-align: center;">${cnt}</div>
		<div> ${numberWithCommas( total_pp )}</div>
	</div>
	`
	*/
	var _html = `
	<tr id="mass_s_${o.cd}" data-cd-value="${o.cd}">
		<t!--d class="image" style="width:150px;background-color: #${color};">
			<div style="position: relative;color: #fff;padding: 5px;min-width: 30px;text-align: center;font-size:15px;font-weight:bold;">${cnt}</div>
			<!--img src="https://ssl.pstatic.net/imgfinance/chart/mobile/mini/${o.cd}_transparent.png" style="width:150px" load="lazy"-->
			
		</td-->
		<td> ${o.nm}( ${o.cd} ) <br> ${o._t} <br> ${o.type}<br> ${o.amt}  / ${numberWithCommas( o.pp )} / ${numberWithCommas( total_pp )}</td>
	</tr>
	`
	

	
	var new_el = htmlToElement( _html )
	
	//if( window._el.id_mass_s.childElementCount > 100 ) //window._el.id_mass_s.lastElementChild.parentNode.removeChild( window._el.id_mass_s.lastElementChild )
	//window._el.id_mass_s.insertBefore( new_el,window._el.id_mass_s.firstChild )	

	//var target_el = window.document.getElementById( "mass_s_" + o.cd )
	//if( target_el )
	//{
	//	window._el.id_mass_s.lastElementChild.parentNode.removeChild( target_el )
	//	window._el.id_mass_s.insertBefore( new_el,window._el.id_mass_s.firstChild )			
		
	//}
	//else
	//{
		window._el.id_mass_s.insertBefore( new_el,window._el.id_mass_s.firstChild )	
	//}
	
	if( window.barchart_cur == o.cd )
	{
		//renderBarChartAddData( o.pp,o._t, o.type )	
	}

	new_el.addEventListener( "click",function(e){
		var cd = e.currentTarget.getAttribute("data-cd-value");
		window.barchart_cur = cd;

		var title =  window.MassData.s[ cd ].data.nm + " ( " + cd + " ) "
		renderBarChart(window.MassData.s[ cd ].data.total.data,title)
		getFTrData( cd )
		getAgcData( cd )
		updateNews( cd )
	})

	setTimeout(function(){
		upadteMassTradDataInsertWatch_s()
	},300)
			
}
var upadteMassTradDataInsertWatch_s = function(){

	if( window._data.s.length == 0 ) 
	{
		return setTimeout(function(){
				upadteMassTradDataInsertWatch_s()
		},1000)
	}
	
	var o = window._data.s.shift();
	
	upadteMassTradDataInsert_s( o );
}


var updateMassTradData_s = function(){

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , `http://112.144.208.118:8888/getMassTradCheck_s?date=${window.date.curDate}&lidx=${window.MassDataInfo.s}&limit=100`, true);
		xhr.onreadystatechange = function() {
			if(xhr.readyState == 4 && xhr.status == 200)
			{
				var a =JSON.parse(xhr.responseText);
				var  i =0,iLen = a.d.length,io;
				for(;i<iLen;++i){
					io = a.d[ i ]
					window._data.s.push( io )
				}

				if( a.nxtId != -1 ) window.MassDataInfo.s = a.nxtId;

				//setTimeout(function(){
				//	updateMassTradData_s();	
				//},3000)

			}
		}
		xhr.send();
}








var getCandle5 = function(cd,cbFunction){

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , `http://112.144.208.118:8888/getCandle5?cd=${cd}`, true);
		xhr.onreadystatechange = function(){

			if( xhr.readyState == 4 && xhr.status == 200)
			{

				var d = JSON.parse( xhr.responseText )
				/*
				candleAccTradePrice: 4178940
candleAccTradeVolume: 2358
candleTime: "2022-02-10 11:30:00.0"
change: null
changePrice: null
changeRate: null
date: "2022-02-10"
highPrice: 1775
lowPrice: 1770
openingPrice: 1775
symbolCode: "KR7012800009"
timestamp: 1644460205658
tradePrice: 1770
tradeTime: "113450"
				
				*/
				//var _o = {
				//	cate : [],
				//	value : []

				//} 
				var arr = [];
				var i = 0,iLen = d.length,io;
				for(;i<iLen;++i){
					io = d[ i ];
					if( io.date != window.date.curDateWidhDash) continue;
					//_o.cate.push(io.candleTime.replace("2022-02-15 ","") )
					//_o.value.push([io.openingPrice, io.tradePrice, io.lowPrice, io.highPrice ])
					arr.push([ io.candleTime,io.tradePrice ])
				}
				cbFunction( arr )
			}
		}

		xhr.send();
	
}



var getRankByCD_b = function(cd,date,cbFunction){

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , `http://112.144.208.118:8888/getMassTradRank_b_Cd?cd=${cd}&date=${date}`, true);
		xhr.onreadystatechange = function(){

			if( xhr.readyState == 4 && xhr.status == 200)
			{

				var d = JSON.parse( xhr.responseText )
				cbFunction( d )
			}
		}

		xhr.send();
	
}

var getRankByCD_s = function(cd,date,cbFunction){

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , `http://112.144.208.118:8888/getMassTradRank_s_Cd?cd=${cd}&date=${date}`, true);
		xhr.onreadystatechange = function(){

			if( xhr.readyState == 4 && xhr.status == 200)
			{

				var d = JSON.parse( xhr.responseText )
				cbFunction( d )
			}
		}

		xhr.send();
	
}

window.barchart = {};
window.barchart_cur = null;
var renderBarChart = function( cd, title ){
		var dom = document.getElementById("container");
		window.barchart = echarts.init(dom);
		var app = {};
		window.barchart.showLoading()
		getRankByCD_b( cd,window.date.curDate, function(d00){
	
		var d1 = []
		var d2 = []
				
		title += ` - 매수금액 : ${numberWithCommas( d00.total_pp )}`
		renderBarChart.arr1 = [];
		renderBarChart.arr2 = [];

		if( d00 != null ) renderBarChart.arr1 = d00.data

			getRankByCD_s( cd,window.date.curDate, function(d01){
			
			if( d01 != null ) renderBarChart.arr2 = d01.data
			title += ` / 매도금액 : ${numberWithCommas( d01.total_pp )}`
				getCandle5( cd, function(d){

				
				var option;
				var candlex = ["09:00:00.0","09:05:00.0","09:10:00.0","09:15:00.0","09:20:00.0","09:25:00.0","09:30:00.0","09:35:00.0","09:40:00.0","09:45:00.0","09:50:00.0","09:55:00.0","10:00:00.0","10:05:00.0","10:10:00.0","10:15:00.0","10:20:00.0","10:25:00.0","10:30:00.0","10:35:00.0","10:40:00.0","10:45:00.0","10:50:00.0","10:55:00.0","11:00:00.0","11:05:00.0","11:10:00.0","11:15:00.0","11:20:00.0","11:25:00.0","11:30:00.0","11:35:00.0","11:40:00.0","11:45:00.0","11:50:00.0","11:55:00.0","12:00:00.0","12:05:00.0","12:10:00.0","12:15:00.0","12:20:00.0","12:25:00.0","12:30:00.0","12:35:00.0","12:40:00.0","12:45:00.0","12:50:00.0","12:55:00.0","13:00:00.0","13:05:00.0","13:10:00.0","13:15:00.0","13:20:00.0","13:25:00.0","13:30:00.0","13:35:00.0","13:40:00.0","13:45:00.0","13:50:00.0","13:55:00.0","14:00:00.0","14:05:00.0","14:10:00.0","14:15:00.0","14:20:00.0","14:25:00.0","14:30:00.0","14:35:00.0","14:40:00.0","14:45:00.0","14:50:00.0","14:55:00.0","15:00:00.0","15:05:00.0","15:10:00.0","15:15:00.0","15:30:00.0",]

				var i = 0,iLen = renderBarChart.arr1.length,io;
				for(;i<iLen;++i){
					io = renderBarChart.arr1[ i ]
					//x.push( io._t )
					d1.push( [ io._t, io.pp ] )
				}

				var i = 0,iLen = renderBarChart.arr2.length,io;
				for(;i<iLen;++i){
					io = renderBarChart.arr2[ i ]
					//x.push( io._t )
					d2.push( [ io._t, io.pp ] )
				}
				
				option = {
					title : { text : title },
					tooltip: {
				trigger: 'axis',
				axisPointer: { type: 'cross' },
				borderWidth: 1,
				borderColor: '#ccc',
				padding: 10,
				//grid:[{
				//	left : "10%"
				//},{ left : "40%" }],
				textStyle: { color: '#000'  },
				position: function (pos, params, el, elRect, size) {
				  const obj = {
					top: 10
				  };
				  obj[['left', 'right'][+(pos[0] < size.viewSize[0] / 2)]] = 30;
				  return obj;
				}
				// extraCssText: 'width: 170px'
			  },
			//		  toolbox: {
			  //  feature: {
			  //    dataZoom: {
			  //      yAxisIndex: 'none'
			  //    },
			  //    restore: {},
			  //    saveAsImage: {}
			  //  }
			  //},
					xAxis: [
						{ type: 'time',scale:true,min: window.date.curDateWidhDash + "T09:00:00",max: window.date.curDateWidhDash + "T15:30:00"  },
						//{  data: candlex,
						//boundaryGap : false,
						//axisLin : { onZero : true }, 
						//min:"2022-02-15T09:00:00",max:"2022-02-15T15:30:00"  }
					],
					yAxis: [
					{ type: 'value', splitArea: {show: true },splitLine: { show: false } },
					{ scale: true, splitArea: {show: false },splitLine: { show: false } }
					],
			  //dataZoom: [
			  //  {
			  //    show: true,
			  //    realtime: true,
			  //    start: 0,
			  //    end: 100,
			  //    xAxisIndex: [0, 1]
			  //  },
			  //  {
			  //    type: 'inside',
			  //    realtime: true,
			  //    start: 0,
			  //    end: 100,
			  //    xAxisIndex: [0, 1]
			  //  }
			  //],
				//	width :dom.offsetWidth + "px",height :dom.offsetHeight + "px",
					series: [
							{ width :"100%",height :"100%",	data: d1,type: 'bar',large:true,//,barWidth:30//,showBackground: true//,backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)'},
							//markPoint: {
							//	data: [
							//	{ type: 'max', name: 'Max' },
							//	{ type: 'min', name: 'Min' }
							//	]
							//},
							//markLine: {
							//	data: [{ type: 'average', name: 'Avg' }]
							//},
							//itemStyle : { color : 'red' }
						}
						,{ width :"100%",height :"100%",	data: d2,type: 'bar',large:true,//,showBackground: true//,backgroundStyle: { color: 'rgba(180, 180, 180, 0.2)'},
							//markPoint: {
							//	data: [
							//	{ type: 'max', name: 'Max' },
							//	{ type: 'min', name: 'Min' }
							//	]
							//},
							//markLine: {
							//	data: [{ type: 'average', name: 'Avg' }]
							//},
							//itemStyle : { color : 'blue' }
						}
						,
						{
							 name: 'Day',
							  type: 'line',
							  //xAxisIndex: 1, 
							  yAxisIndex: 1,
							  data: d,
								markPoint: {
									data: [
									{ type: 'max', name: 'Max' },
									{ type: 'min', name: 'Min' }
									]
								},
							  //itemStyle : { opacity:0.3 },
							  //tooltip: {
								//formatter: function (param) {
								//  param = param[0];
								//  return [
								//	'Date: ' + param.name + '<hr size=1 style="margin: 3px 0">',
								//	'Open: ' + param.data[0] + '<br/>',
								//	'Close: ' + param.data[1] + '<br/>',
								//	'Lowest: ' + param.data[2] + '<br/>',
								//	'Highest: ' + param.data[3] + '<br/>'
								//  ].join('');
								//}
								//}
						}
					]
				};

				if (option && typeof option === 'object') {
					
					window.barchart.setOption(option);

					window.barchart.resize();
					window.barchart.hideLoading()
				}
			})
		})
	})
	
	
}

var getTotalTradPrice = function( cd ){
		
		window._el.id_totalTradPrice.innerHTML = "";
		getRankByCD_b( cd,window.date.curDate, function(d00){
			
			var _t0 = d00.total_pp
			var _t = `매수금액 : ${numberWithCommas( d00.total_pp )}`

			getRankByCD_s( cd,window.date.curDate, function(d01){
			debugger;
			_t0 = _t0 + d01.total_pp
			_t += ` / 매도금액 : ${numberWithCommas( d01.total_pp )}`
			html = `
			<div style="font-size:15px;font-weight:bold;">대금갭 : ${numberWithCommas(_t0 )}/ ${_t}</div>
			`
			window._el.id_totalTradPrice.innerHTML = html
		})
	})
	
}

var updateStock = function( cd ){
		
	var xhr = new XMLHttpRequest();
	xhr.open("GET" , "http://112.144.208.118:8888/getStockInfoByCd?cd=" + cd, true);
	xhr.onreadystatechange = function() {
		if(xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText )

				var status = {
					"EVEN" : {	color:"grey", symbol : "-",},
					"RISE" : {	color:"red", symbol : "▲",},
					"FALL" : {	color:"blue", symbol : "▼",},
					"UPPER_LIMIT" : {	color:"red", symbol : "▲",},
				}
			
			var color = status[ d.change ].color
			var symbol = status[ d.change ].symbol
			var _htmlTxt = `
			<div><span style='font-size:25px;padding:10px'>${ d.name }</span>  ( ${ d.symbolCode } )</div>
			<div style="padding:10px">
			<span style="color:${color};font-size:17px;font-weight:bold;">  ${numberWithCommas( d.askPrice )}</span>
			<span style="color:${color};"> ${symbol} ${numberWithCommas( d.changePrice )} ( ${(d.changeRate*100).toFixed(2)} % )</span></br>
			<span style="">  거래량 : ${numberWithCommas( d.accTradeVolume )} | 거래대금 ${numberWithCommas( d.accTradePrice )} </span>
			</div>
			<div style="padding:10px">
			<span style="font-size:11px;">${d.companySummary}</span>
			</div>`
			window._el.id_stockInfo.innerHTML = _htmlTxt;
		}
	}
	xhr.send();
}

var renderBarChartAddData = function( data0, data1, type ){
	var option = window.barchart.getOption();
	
	var key = 0;
	if( type == 0 ) key = 1
	option.series[key].data.push([ data1, data0 ])

	//console.log( option.series[key].data )

	//window.barchart.setOption(option);
}
var _html_updateStock = function( p ){
	
	if( p > 0 )  return "red"
	else if( p < 0) return "blue"
	else return "#666"
}
var getAgcData = function(cd){
	
	var xhr = new XMLHttpRequest();
	xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getTrStatusByCd?cd=${cd}` ) , true);
    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            
			var a =JSON.parse(xhr.responseText);
			if( a == null ) return;
			var _htmlTxt = ""
			var agency_data = `
			<table class="ui celled table compact">
				<thead>
					<tr>
						<th> 일자   </th>
						<th> 현재가격 </th>
						<th> 거래량  </th>
						<!--th> "cd"   </th-->
						<th> 전일비  </th>
						<th> 등락률   </th>
						<th> 개인  </th>
						<th> 외국인  </th>
						<th> 기관계  </th>
						<th> 금융투자  </th>
						<th> 보험  </th>
						<th> 투신  </th>
						<th> 기타금융  </th>
						<th> 은행  </th>
						<th> 연기금등  </th>
						<th> 사모펀드 </th>
						<th> 국가 </th>
						<th> 기타법인 </th>
						<th> 내외국인 </th>
					</tr>
				</thead>
				<tbody>
			`
			//var i =0,iLen = d.length,io;
			var i =0,iLen = 7,io;
			for(;i<iLen;++i){
				io = a[ i ];

				agency_data += "<tr>"
				agency_data += "<td>" + io._t + "</td>"  
				agency_data += "<td>" + io.price + "</td>"  
				agency_data += "<td>" + io.amt  + "</td>"  
				//agency_data += "<td>" + io.cd  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.ydt )};'>` + io.ydt + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.rt )};'>` + io.rt   + "</td>"  
				
				agency_data += `<td style='color:${_html_updateStock( io.tr1 )};'>` + io.tr1  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr2 )};'>` + io.tr2  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr3 )};'>` + io.tr3  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr4 )};'>` + io.tr4  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr5 )};'>` + io.tr5  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr6 )};'>` + io.tr6  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr7 )};'>` + io.tr7  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr8 )};'>` + io.tr8  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr9 )};'>` + io.tr9  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr10 )};'>` + io.tr10  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr11 )};'>` + io.tr11  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr12 )};'>` + io.tr12  + "</td>"  
				agency_data += `<td style='color:${_html_updateStock( io.tr13 )};'>` + io.tr13  + "</td>"  

				agency_data += "</tr>"
			}
			
			agency_data += `</tbody></table>`
			window._el.id_AgcData.innerHTML = agency_data
		}
	}

	xhr.send();

}

var getFTrData = function(cd){
	
	var xhr = new XMLHttpRequest();
	
	window.stock = {};
	window.stock_arr = [];
//    xhr.open("GET" , encodeURI("http://112.144.208.118:8888/getInsightByStock?date=" + getTimeTo__YYYYMMDD() ) , true);
    xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getInsightByStockCd?cd=${cd}&date=${window.date.curDate}` ) , true);

    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            var a =JSON.parse(xhr.responseText);
			window._el.id_FtrData.innerHTML = "";
			if( a == null )
			{
				var fr_data = `
				<table class="ui celled table compact">
					<thead>
					<tr>
						<th rowspan="2">외국계증권사</th>
						<th colspan="3">거래량</th>
						<th colspan="3">거래대금</th>
					</tr>
					<tr>
						<th>매수</th>
						<th>매도</th>
						<th>순매수</th>
						<th>매수</th>
						<th>매도</th>
						<th>순매수</th>
					</tr>
					</thead>
					<tbody>
						<tr>
							<td colspan="6"> 데이터가 없음</td>
						</tr>
					</tbody>
				</table>
					`

			}
			else
			{
				var _html = "";
		
				var _tempArr = [];
				var z,zo;
				for( z in a[ "trs" ] ){
					zo = a[ "trs" ][ z ];
					zo.pp = zo.b + zo.s
					zo.pp_amt = zo.b_amt + zo.s_amt
					zo.nm = z;
					_tempArr.push( zo )
				}

				_tempArr.sort((a,b) => (a.pp < b.pp) ? 1 : ((b.pp < a.pp) ? -1 : 0))
				

				var fr_data = `
				<table class="ui celled table compact">
					<thead>
					<tr>
						<th rowspan="2">외국계증권사</th>
						<th colspan="3">거래량</th>
						<th colspan="3">거래대금</th>
					</tr>
					<tr>
						<th>매수</th>
						<th>매도</th>
						<th>순매수</th>
						<th>매수</th>
						<th>매도</th>
						<th>순매수</th>
					</tr>
					</thead>
					<tbody>
				`;
				var k = 0,kLen = _tempArr.length,ko;
				for(;k<kLen;++k){
					ko = _tempArr[ k ]
						
					var bgColor = "#ccc";
					var Color = "#666";

					if( ko.pp > 0 )
					{
						bgColor ="red"
						Color = "#fff"
					}

					if( ko.pp < 0 )
					{
						bgColor ="blue"
						Color = "#fff"
					}

					fr_data += `<tr style='background-color:${bgColor};color:${Color};'>`
					fr_data += `<td>${ko.nm}</td>`
					fr_data += `<td>${numberWithCommas( ko.b_amt )}</td>`
					fr_data += `<td>${numberWithCommas( ko.s_amt )}</td>`
					fr_data += `<td>${numberWithCommas( ko.pp_amt )}</td>`
					fr_data += `<td>${numberWithCommas( ko.b )}</td>`
					fr_data += `<td>${numberWithCommas( ko.s )}</td>`
					fr_data += `<td>${numberWithCommas( ko.pp )}</td>`
					//fr_data += `<td>${zo.CONV_OBJ_TP_CD}</td>`

					fr_data += "</tr>"						

				}

				fr_data += `<tr style='background-color:yellow;color:red;'>`
				fr_data += `<td>전체</td>`
				fr_data += `<td>${numberWithCommas( a.total[ "b_amt" ] )}</td>`
				fr_data += `<td>${numberWithCommas( a.total[ "s_amt" ] )}</td>`
				fr_data += `<td>${numberWithCommas( a.total.pp_amt )}</td>`
				fr_data += `<td>${numberWithCommas( a.total[ "b" ] )}</td>`
				fr_data += `<td>${numberWithCommas( a.total[ "s" ] )}</td>`
				fr_data += `<td>${numberWithCommas( a.total.pp )}</td>`
				//fr_data += `<td>${zo.CONV_OBJ_TP_CD}</td>`
				fr_data += "</tr>"	
				fr_data += "</tbody>"
				fr_data += "</table>";

			}
					
			window._el.id_FtrData.innerHTML = fr_data

			/*
			var chartImgs = window.document.getElementsByClassName("chart");
			
			setInterval(function(){
				var k = 0,kLen = chartImgs.length,ko;
				for(;k<kLen;++k){
					ko = chartImgs[ k ]
					var _tsrc = ko.src
					ko.src = _tsrc.split("?")[0] + "?" + Date.now();
				}	
			},60000)
			*/
		}
	}
	xhr.send();

}


var getTrdRank = function(cd){
	
	var xhr = new XMLHttpRequest();
	
    xhr.open("GET" , encodeURI(`http://112.144.208.118:8888/getTraderRank?cd=${cd}` ) , true);

    xhr.onreadystatechange = function() {

        if(xhr.readyState == 4 && xhr.status == 200)
        {
            var a =JSON.parse(xhr.responseText);

			window._el.id_trd_data.innerHTML = "";
		
				var _html = "";
		
				var _tempArr = [];
				var z,zo;
				for( z in a ){
					zo = a[ z ];
					zo.nm = z;
					_tempArr.push( zo )
				}

				_tempArr.sort((a,b) => (a.bidAccTradeVolume < b.bidAccTradeVolume) ? 1 : ((b.bidAccTradeVolume < a.bidAccTradeVolume) ? -1 : 0))
				

				var fr_data = `
				<table class="ui celled table compact">
					<thead>
					<tr>
						<th>증권사</th>
						<th>매수</th>
						<th>매도</th>
						<th>순매수</th>
					</tr>
					</thead>
					<tbody>
				`;
				//{"rank":6,"traderName":"KB증권","askAccTradeVolume":0,"bidAccTradeVolume":106817,"netSales":106817,"isForeignInvestor":false,"isLeftStock":true},
				var k = 0,kLen = _tempArr.length,ko;
				for(;k<kLen;++k){
					ko = _tempArr[ k ]
						

					fr_data += `<tr>`
					fr_data += `<td>${ko.traderName}</td>`
					fr_data += `<td style="color:${ko.bidAccTradeVolume > 0 ? "red" : ko.bidAccTradeVolume == 0 ? "#666" : ""}">${numberWithCommas( ko.bidAccTradeVolume )}</td>`
					fr_data += `<td style="color:${ko.askAccTradeVolume > 0 ? "blue" : ko.askAccTradeVolume == 0 ? "#666" : ""}">${numberWithCommas( ko.askAccTradeVolume )}</td>`
					fr_data += `<td style="color:${ko.netSales > 0 ? "red" : ko.netSales < 0 ? "blue" : ko.netSales == 0 ? "#666" : ""}">${numberWithCommas( ko.netSales )}</td>`
					fr_data += "</tr>"						

				}
				fr_data += "</tbody>"
				fr_data += "</table>";

					
			window._el.id_trd_data.innerHTML = fr_data

			/*
			var chartImgs = window.document.getElementsByClassName("chart");
			
			setInterval(function(){
				var k = 0,kLen = chartImgs.length,ko;
				for(;k<kLen;++k){
					ko = chartImgs[ k ]
					var _tsrc = ko.src
					ko.src = _tsrc.split("?")[0] + "?" + Date.now();
				}	
			},60000)
			*/
		}
	}
	xhr.send();

}

var updateNews = function( cd ){
		

		var xhr = new XMLHttpRequest();

		xhr.open("GET" , "http://112.144.208.118:8888/getNewsByCdFromDaum?cd=" + cd, true);

		xhr.onreadystatechange = function() {

			if(xhr.readyState == 4 && xhr.status == 200)
			{
				var d = JSON.parse( xhr.responseText )
				var _htmlTxt = ""
				
				var i = 0,iLen = d.data.length,io;
				for(;i<iLen;++i){
					io = d.data[ i ]
					var a = ""
					var b = `<div class="sixteen wide column" style="">
						<div><img src="${io.imageUrl}" style="width: 100%;height:80px;object-fit:cover;" loading='lazy'></div>
					  </div>`
					if( io.imageUrl == null )
					{
						a = "sixteen";
						b = "";

					}
					else
					{
						a = "sixteen"
					}
					_htmlTxt += `<div class="ui grid" style="padding:0px 0 0px 0;">
					<!--${b}-->
					  <div class="${a} wide column">
						<div stlye="margin-bottom:40px;"><span style="font-size:18px;font-weight: bold;line-height:22px;">${io.title}</span></div>
						<div stlye="margin-bottom:40px;"><span style="font-size:12px;font-weight: bold;line-height:22px;">${io.summary}</span></div>
						<div stlye="margin-bottom:25px;"><span style="font-size:11px;color:#666;">${io.cpKorName} · ${io.createdAt} · <img src="https://t1.daumcdn.net/top/favicon.ico" style="width:15px"></span></div>
					  </div>
					</div>`	
				}

				window._el.id_news.innerHTML += _htmlTxt
			}

		}

		xhr.send();
	
	
}
updateNews.cnt = 0;
updateNews.status = 0;


var updateNewsFromNaver = function( cd ){
	
	if( !cd ) return;

	var xhr = new XMLHttpRequest();
	xhr.open("GET" , "http://112.144.208.118:8888/getNewsByCdFromNaver?cd=" + cd, true);
	xhr.onreadystatechange = function() {

		if(xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText )
			var _htmlTxt = ""
			
			var i = 0,iLen = d.length,io;
			for(;i<iLen;++i){
				io = d[ i ].items[0]
				var a = ""
				var b = `<div class="sixteen wide column" style="">
					<div><img src="${io.imageOrginLink}" style="width: 100%;height:80px;object-fit:cover;" loading='lazy'></div>
					</div>`
				if( io.imageOrginLink == null )
				{
					a = "sixteen";
					b = "";

				}
				else
				{
					a = "sixteen"
				}
				_htmlTxt += `<div class="ui grid" style="padding:0px 0 0px 0;">
				<!--${b}-->
					<div class="${a} wide column">
					<div stlye="margin-bottom:40px;"><span style="font-size:18px;font-weight: bold;line-height:22px;">${io.titleFull}</span></div>
					<div stlye="margin-bottom:40px;"><span style="font-size:12px;font-weight: bold;line-height:22px;">${io.body}</span></div>
					<div stlye="margin-bottom:25px;"><span style="font-size:11px;color:#666;">${io.officeName} · ${io.datetime} · <img src="https://ssl.pstatic.net/imgstock/favicon.ico" style="width:15px;"></span></div>
					</div>
				</div>`	
			}

			window._el.id_news.innerHTML += _htmlTxt
		}

	}

	xhr.send();
}
var searchStock = function(q,cbFunction){
	console.log( q )
	var xhr = new XMLHttpRequest();

	//http://112.144.208.118:8888/getCandleDataByCd?cd=510007&startTime=20220201&endTime=20220214
	xhr.open("GET" , `http://112.144.208.118:8888/getStockSearch?q=${q}`, true);

	xhr.onreadystatechange = function() {

		if(xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText );
			console.log( d.suggestItems );
			cbFunction(d.suggestItems)
		}

	}
	xhr.send();
}

var makeSearchList = function( arr ){

	window._el.id_searchResult.style.width = window._el.id_search.offsetWidth + "px";
	window._el.id_searchResult.style.display = "block";
	window._el.id_searchResult.innerHTML = "";

	var html = ""
	var i =0,iLen =arr.length,io;
	for(;i<iLen;++i){
		io = arr[ i ];
		html = `
		<div class="item" id="search_result_${io.displayedCode}" data-cd-value="${io.displayedCode}">(${io.displayedCode}) - ${io.koreanName}</div>
		`
	

		var new_el = htmlToElement( html )
		var target_el = window.document.getElementById( "search_result_" + io.displayedCode )
		if( target_el )
		{
			window._el.id_searchResult.lastElementChild.parentNode.removeChild( target_el )
			window._el.id_searchResult.insertBefore( new_el,window._el.id_searchResult.firstChild )			
			
		}
		else
		{
			window._el.id_searchResult.insertBefore( new_el,window._el.id_searchResult.firstChild )	
		}

		new_el.addEventListener( "click",function(e){
			
			var cd = e.currentTarget.getAttribute("data-cd-value");
			
			window._el.id_searchResult.innerHTML = "";				
			//candleChart 페이지로이동시킴;
			var a = window.document.createElement( "a" );
			a.target = "_blank";
			a.href = "/html/candle.html?cd=" + cd
			a.click();
		})
	}
	//window._el.id_searchResult.innerHTML = html
}

var getFtrdDataByCd = function(cd,date,cbFunction){
	var xhr = new XMLHttpRequest();

	//http://112.144.208.118:8888/getCandleDataByCd?cd=510007&startTime=20220201&endTime=20220214
	xhr.open("GET" , `http://112.144.208.118:8888/getFtrdDataByCd?cd=${cd}&date=${date}`, true);

	xhr.onreadystatechange = function() {

		if(xhr.readyState == 4 && xhr.status == 200)
		{
			var d = JSON.parse( xhr.responseText );
			
			cbFunction(d)
		}

	}
	xhr.send();
}
window.scatterchart = {};
window.scatterchart_cur = null;
var renderScatterChart = function( cd, title ){
		if( window.scatterchart.dispose ) window.scatterchart.dispose()
		var dom = document.getElementById("scatter");
		window.scatterchart = echarts.init(dom);
		var app = {};
		window.scatterchart.showLoading()
		getFtrdDataByCd( cd,window.date.curDate, function(d){
		var chartData = [];
		var legendData = [];
		var _o = {  
			name: 'Female', type: 'scatter',  emphasis: { focus: 'series' },
			data: [],
			markPoint: { data: [ { type: 'max', name: 'Max' }, { type: 'min', name: 'Min' } ] },
			markLine: {lineStyle: { type: 'solid'	},data: [{ type: 'average', name: 'AVG' }, { xAxis: 160 }] }
		}
		
		var _to = {}
		var i = 0,iLen = d.length,io
		for(;i<iLen;++i){
			io = d[ i ];
			if( !_to[ io.tr ] ) _to[ io.tr ] = []
			var amt = io.amt;
			if( io.tt == 0 ) var amt = io.amt;
			_to[ io.tr ].push( [  "2022-02-22T"+ io.ogText.split("\t")[0],amt ] )
		}
		var s,so
		for( s in _to )
		{
			so = _to[ s ]
			legendData.push( s );
			_o = {  
				name: s, type: 'scatter',  emphasis: { focus: 'series' },
				data: so,
				//markPoint: { data: [ { type: 'max', name: 'Max' }, { type: 'min', name: 'Min' } ] },
				//markLine: {lineStyle: { type: 'solid'	},data: [{ type: 'average', name: 'AVG' }, { xAxis: 160 }] }
			}
			chartData.push( _o )
		}

		option = {
			  title: {
				text: '외국계증권사 매수/매도 분포',
//				subtext: 'Data from: Heinz 2003'
			  },
			  grid: { left: '3%', right: '7%', bottom: '10%', containLabel: true },
			  tooltip: {
				// trigger: 'axis',
				showDelay: 0,
				formatter: function (params) {
				  if (params.value.length > 1) {
					return ( params.seriesName + ' :<br/>' + params.value[0] + ' / ' + params.value[1] );
				  } else {
					return ( params.seriesName + ' :<br/>' + params.name + ' : ' +  params.value );
				  }
				},
				axisPointer: { show: true, type: 'cross', lineStyle: { type: 'dashed', width: 1 } }
			  },
			  toolbox: { feature: { dataZoom: {}, brush: { type: ['rect', 'polygon', 'clear'] }	} },
			  brush: {},
			  legend: {	data: legendData,left: 'center',bottom: 0 },
			  xAxis: [
				{ type: 'time',min:"2022-02-22T09:00:00",max:"2022-02-22T15:30:00", scale: true, splitLine: { show: false  }}
			 ],
			  yAxis: [
				{  type: 'value', scale: true, splitLine: { show: false  } }
			  ],
			  series: chartData
			};
	
			if (option && typeof option === 'object') {
				window.scatterchart.setOption(option);

				window.scatterchart.resize();
				window.scatterchart.hideLoading()
			}
	})
}

var insertChart00 = function( cd ){
	window._el.id_realTimeChart.innerHTML = "";
	var _htmlTxt = `
	<img src="https://ssl.pstatic.net/imgfinance/chart/item/candle/day/${cd}.png">`
	//https://ssl.pstatic.net/imgfinance/chart/item/candle/day/373220.png?sidcode=1646279022129
	window._el.id_realTimeChart.innerHTML = _htmlTxt
	return;
}

window.addEventListener('DOMContentLoaded', (event) => {


	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;

	window._el = {}
	window._el.id_mass_b_rank = window.document.getElementById( "mass_b_rank")
	window._el.id_mass_s_rank = window.document.getElementById( "mass_s_rank")
	window._el.id_mass_s = window.document.getElementById("mass_s");
	window._el.id_mass_b = window.document.getElementById("mass_b");
	window._el.id_FtrData = window.document.getElementById("FtrData");
	window._el.id_AgcData = window.document.getElementById("AgcData");
	window._el.id_news = window.document.getElementById("news");
	window._el.id_chart00 = window.document.getElementById("chart00");
	window._el.id_mass_b_s = window.document.getElementById("mass_b_s");
	window._el.id_trd_data = window.document.getElementById("trd_data");
	window._el.id_realTimeChart = window.document.getElementById("realTimeChart");
	window._el.id_totalTradPrice = window.document.getElementById("totalTradPrice");
	window._el.id_search = window.document.getElementById("search");
	window._el.id_searchResult = window.document.getElementById("searchResult");
	window._el.id_stockInfo = window.document.getElementById("stockInfo");
	window._el.id_search_wrap = window.document.getElementById("search_wrap");
	window._el.id_tree_wics = window.document.getElementById( "tree_wics" )
	window._el.id_wics_stocks = window.document.getElementById( "wics_stocks" )
	window._el.id_market_index = window.document.getElementById( "market_index" )
	window._el.id_market_index_1 = window.document.getElementById( "market_index_1" )
	window._el.id_rank_rt = window.document.getElementById( "rank_rt" )

	window._el.id_menu_00 = window.document.getElementById("menu_00");
	window._el.id_menu_01 = window.document.getElementById("menu_01");
	window._el.id_menu_02 = window.document.getElementById("menu_02");
	window._el.id_menu_03 = window.document.getElementById("menu_03");
	window._el.id_menu_04 = window.document.getElementById("menu_04");

	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;


	window.MassData = {};
	window.MassData.b = {};
	window.MassData.s = {};

	window.MassDataRank = [];

	window.socketData = {}
	window._data = {};
	window._data.b = [];
	window._data.s = [];

	window.MassDataInfo = {}
	window.MassDataInfo.b = 0
	window.MassDataInfo.s = 0

	window.stock = {};
	window.stock_arr = [];

	window.date = {}
	window.date.curDate = getTimeTo__YYYYMMDD();
	window.date.curDateWidhDash = getTimeTo__YYYY_MM_DD();


	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;



	//updateRank();
	updateRankWics();
	window.wsFns.getMarketIndex( function(){ window.wsFns.getMarketIndexGlobal(); } );
	//updateRank_s();
	//updateMassTradData();
	//updateMassTradData_s();
	//upadteMassTradDataInsertWatch();
	//upadteMassTradDataInsertWatch_s();


	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;
	//-------------------------------------------------------;


	window.document.addEventListener('click',function(e){ window._el.id_searchResult.style.display = "none"; });

	window._el.id_menu_00.addEventListener('click',function(e){
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = `/html/실시간대량거래.html`;
		a.click();
	});

	window._el.id_menu_01.addEventListener('click',function(e){
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = `/html/기관거래원별.html?date=${window.date.curDate}`;
		a.click();
	});

	window._el.id_menu_02.addEventListener('click',function(e){
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = `/html/외국계거래원별.html?date=${window.date.curDate}`;
		a.click();
	});

	window._el.id_menu_03.addEventListener('click',function(e){
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = `/html/외국계증권사매매동향.html?date=${window.date.curDate}`;
		a.click();
	});

	window._el.id_menu_04.addEventListener('click',function(e){
		var a = window.document.createElement( "a" );
		a.target = "_blank";
		a.href = `/html/wics업종별현황.html?date=${window.date.curDate}`;
		a.click();
	});

	window.addEventListener('resize', function(e){ window.treemapChart.resize(); }, true);

	window._el.id_search.addEventListener('keyup', function(e){
	
		if( e.currentTarget.value == "" )
		{
			window._el.id_searchResult.style.display = "none"
			window._el.id_searchResult.innerHTML = "";
		}
		else
		{
			if (window.event.keyCode == 13) {
				searchStock( e.currentTarget.value,function(d){
					if(d.length == 1 )
					{
						window._el.id_searchResult.style.display = "none"
						window._el.id_searchResult.innerHTML = "";
						var cd = d[0].displayedCode;				
						//candleChart 페이지로이동시킴;
						var a = window.document.createElement( "a" );
						a.target = "_blank";
						a.href = "/html/candle.html?cd=" + cd
						a.click();					
					}
					else if( d.length > 1 )
					{
						makeSearchList(d)
					}

				});
			}
			else
			{
				searchStock( e.currentTarget.value,function(d){
					if( d.length == 0)
					{
						window._el.id_searchResult.style.display = "none"
						window._el.id_searchResult.innerHTML = "";
					}
					else
					{
						makeSearchList(d)	
					}
				});
			
			}	
		}
	})
	window.ws = new WebSocket("ws://112.144.208.118:8888/index.html");

	window.ws.onopen = function(e) {
		console.log("[open] 커넥션이 만들어졌습니다.");
		console.log("데이터를 서버에 전송해봅시다.");
		
		//서버에 socket 요청;
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "renderMassTransInfo_buy" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "renderMassTransInfo_sell" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "makeMassTransList_buy", param : window.massTransData.buy.offset } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "renderMassTransList_buy" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "updateRank_buy" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "updateRank_sell" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "updateRank_sell" } ) )
		//window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "renderTradeValueInfo_gap" } ) )
		window.ws.send( JSON.stringify( { type : "execFunc", funcNm : "renderTradeValueInfo" } ) )
	};

	window.ws.onmessage = function(e) {
		
		var reader = new FileReader();
		reader.onload = function() {

			try
			{
				var d = JSON.parse( reader.result ) 
				//console.log( d.type + " - " + d.nm )
				window.socketData[ d.nm ] = JSON.parse( d.d )
				console.log( d.func );
				var p = null;
				if( d.p !== null || !d.p ) p = d.p = null
				window.wsFns[ d.func ]( p )	
			}
			catch( er )
			{
				debugger;
			}
			
		}
		reader.readAsText(e.data);

	};

	window.ws.onclose = function(event){
		if (event.wasClean) {
			console.log(`[close] 커넥션이 정상적으로 종료되었습니다(code=${event.code} reason=${event.reason})`);
		} else {
			// 예시: 프로세스가 죽거나 네트워크에 장애가 있는 경우
			// event.code가 1006이 됩니다.
			console.log('[close] 커넥션이 죽었습니다.');
			console.log('--커낵션을다시 연결합니다.');
			setTimeout(function(){ window.ws = new WebSocket("ws://112.144.208.118:8888/index.html"); },5000)
		}
	};

	window.ws.onerror = function(error) { console.log(`[error] ${error.message}`); };

	window.interval = {}
	//window.interval.renderUpdateRank_pp = setInterval(function(){
	//	if( !window.socketData.renderMassTransInfo_sell ) return;
	//	if( !window.socketData.renderMassTransInfo_buy ) return;
	//	window.wsFns.renderUpdateRank_pp()
	//},7000)
	//window.interval.renderUpdateRank_rt = setInterval(function(){
	//	if( !window.socketData.renderMassTransInfo_sell ) return;
	//	if( !window.socketData.renderMassTransInfo_buy ) return;
	//	window.wsFns.renderUpdateRank_rt()
	//},7000)
	//window.interval.renderMassTransList_buy = setInterval(function(){
	//	if( !window.socketData.renderMassTransInfo_sell ) return;
	//	if( !window.socketData.renderMassTransInfo_buy ) return;
	//	window.wsFns.renderMassTransList_buy()
	//},7000)
})
</script>

<body style="padding:50px;">
	<div class="ui grid">
		<div class="eight wide column" style="padding: 20px;">
			<span id="menu_00" style="cursor:pointer;">실시간대량거래</span> | 
			<span id="menu_01" style="cursor:pointer;">기관거래원별</span> | 
			<span id="menu_02" style="cursor:pointer;">외국계거래원별</span> | 
			<span id="menu_03" style="cursor:pointer;">외국계증권사매매동향</span> | 
			<span id="menu_04" style="cursor:pointer;">wics업종별현황</span>
		</div>
		<div class="eight wide column" style="padding: 20px;" id="search_wrap">
				<div class="ui fluid icon input">
					<input type="text" placeholder="Search a very wide input..." id="search">
					<i class="search icon"></i>
				</div>
				<div class="ui list" id="searchResult" style="position: absolute;z-index: 100;background-color: #fff;border:1px solid #ccc;width:491px;padding:10px;display:none;"></div>
		</div>
		<div class="sixteen wide column">
			<div class="ui grid">
				<div class="sixteen wide column" id="market_index_title" style="">
				국내외증시
				</div>
				<div class="six wide column">
					<div class="ui two cards" id="market_index"></div>
				</div>
				<div class="ten wide column">
					<div class="ui five cards" id="market_index_1"></div>
				</div>
			</div>
		</div>
		<div class="sixteen wide column">
			<div class="ui grid">
				<div class="sixteen wide column" id="tradeValueTree_title" style="">
				실시간거래대금 및 등락률 현황
				</div>
				<div class="sixteen wide column" id="tradeValueTree" style="text-align:center;height:800px;padding:0px;"></div>		
			</div>
		</div>
		<!--div class="sixteen wide column" id="tradeValueTreeGap" style="text-align:center;height:800px;padding:0px;"></div-->
		
		<!-- <div class="six wide column" id="tree_01" style="text-align:center;height:900px;padding:0px;"></div> -->
		
		<!-- <div class="five wide column" id="tree" style="text-align:center;height:900px;padding:0px;"></div> -->
		
		<!-- <div class="five wide column" id="tree_00" style="text-align:center;height:900px;padding:0px;"></div> -->
		
		<!--div class="sixteen wide column" id="rank_rt" style="text-align:center;height:1200px;padding:0px;"></div-->
		
		<!--div class="sixteen wide column" id="tradeValueTree" style="text-align:center;height:900px;padding:0px;"></div-->
		
		<!-- <div class="sixteen wide column"> -->
		<!-- 	<div class="ui grid"> -->
		<!-- 		<div class="sixteen wide column"> -->
		<!-- 			<!-- <div class="ui eight cards" id="market_index"></div> -->
		<!-- 			<div class="ui ten cards" id="market_index_1"></div> -->
		<!-- 		</div> -->
		<!-- 	</div> -->
		<!-- </div> -->
		<div class="sixteen wide column">
			<div class="ui grid">
				<div class="eight wide column" id="wicsTree" style="height:900px;padding:0px;"></div>
				<div class="eight wide column" id="" style="">
					<div class="ui five cards" id="wics_stocks"></div>
				</div>
			</div>
		</div>
	</div>
</body>